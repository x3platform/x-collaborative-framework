// -*- ecoding=utf-8 -*-
// Name		:x-client-api 
// Version	:1.0.0 
// Author	:ruanyu@live.com 
// Date		:2015-11-24
x.workflow={settings:{workflowNodeActorMethods:"[{text:'会签',value:'会签'},{text:'校稿',value:'校稿'},{text:'审核(需要所有人同意)',value:'审核'},{text:'并审(需要其中一人同意)',value:'并审'},{text:'审批(审核+批准)',value:'审批'},{text:'批准',value:'批准'},{text:'抄送',value:'抄送'}]",workflowNodeSelector:".workflow-node",workflowNodeNewSelector:".workflow-node-new",workflowSwitcherExitSelector:".workflow-switcher-exit",workflowSwitcherExitNewSelector:".workflow-switcher-exit-new",workflowSwitcherExitConditionSelector:".workflow-switcher-exit-condition",workflowSwitcherExitConditionNewSelector:".workflow-switcher-exit-condition-new"},reminder:function(a){if(confirm("确定发送催办消息给审批人?")){var b='<?xml version="1.0" encoding="utf-8"?>';b+="<request>","undefined"!=typeof a.clientTargetObject&&(b+="<clientTargetObject><![CDATA["+a.clientTargetObject+"]]></clientTargetObject>"),b+="<customTableName><![CDATA["+a.customTableName+"]]></customTableName>",b+="<entityId><![CDATA["+a.entityId+"]]></entityId>",b+="<entityClassName><![CDATA["+a.entityClassName+"]]></entityClassName>",b+="<workflowInstanceId><![CDATA["+a.workflowInstanceId+"]]></workflowInstanceId>",b+="<sendUrlFormat><![CDATA["+a.sendUrlFormat+"]]></sendUrlFormat>",b+="<tags><![CDATA["+a.tags+"]]></tags>",b+="</request>",x.net.xhr("/api/kernel.entities.operationLog.reminder.aspx",b,{popCorrectValue:1})}},workflowRequest:{start:function(a,b,c,d){x.workflow.workflowRequest.transact({url:"/api/workflow.client.start.aspx",templateId:a,entityId:b,entityClassName:c,title:"undefined"==typeof d?"":d.title,idea:"undefined"==typeof d?"":d.idea})},next:function(a,b,c,d){x.workflow.workflowRequest.transact({url:"/api/workflow.client.next.aspx",instanceId:a,nodeId:b,historyNodeId:c,title:"undefined"==typeof d?"":d.title,idea:"undefined"==typeof d?"":d.idea})},gotoStartNode:function(a,b,c,d){return""===d?void alert("驳回操作必须填写意见。"):void x.workflow.workflowRequest.transact({url:"/api/workflow.client.gotoStartNode.aspx",instanceId:a,nodeId:b,historyNodeId:c,idea:d})},gotoRejectNode:function(a,b,c,d){x.workflow.workflowRequest.transact({url:"/api/workflow.client.gotoRejectNode.aspx",instanceId:a,nodeId:b,historyNodeId:c,title:"undefined"==typeof d?"":d.title,idea:"undefined"==typeof d?"":d.idea})},transact:function(a){var b='<?xml version="1.0" encoding="utf-8" ?>';b+="<request>",b+="<action><![CDATA[start]]></action>",b+="<templateId><![CDATA["+a.templateId+"]]></templateId>",b+="<entityId><![CDATA["+a.entityId+"]]></entityId>",b+="<title><![CDATA["+a.title+"]]></title>",b+="<idea><![CDATA["+a.idea+"]]></idea>",b+="</request>",$.post(a.url,{resultType:"json",xml:b},function(b){var c=x.toJSON(b).message;switch(Number(c.returnCode)){case 0:"undefined"!=typeof a.callback&&a.callback();break;case-1:case 1:alert(c.value)}})}},designtime:{createDesignXml:function(){return x.debug.warn("函数【x.workflow.designtime.createDesignXml】已过时了，可以使用新的函数【x.workflow.template.serialize】。"),x.workflow.template.serialize()},getTemplateByWorkflowTemplateId:function(a,b,c,d,e){x.debug.warn("函数【x.designtime.getTemplateByWorkflowTemplateId】已过时了，可以使用新的函数【x.workflow.template.download】。"),x.workflow.template.download({toolbar:c,container:b,url:"/api/workflow.template.findOne.aspx",id:a,fectchExpectedActors:d,corporationId:"undefined"==typeof e?"":e.corporationId,projectId:"undefined"==typeof e?"":e.projectId,startActorId:"undefined"==typeof e?"":e.startActorId})},getTemplateByWorkflowInstanceId:function(a,b,c,d,e,f){x.debug.warn("函数【x.designtime.getTemplateByWorkflowInstanceId】已过时了，可以使用新的函数【x.workflow.template.download】。"),x.workflow.template.download({toolbar:c,container:b,url:"/api/workflow.instance.getTemplateByWorkflowInstanceId.aspx",id:a,fectchExpectedActors:d,fectchFinishedActors:e,corporationId:"undefined"==typeof f?"":f.corporationId,projectId:"undefined"==typeof f?"":f.projectId})},getTemplateByWorkflowNodeId:function(a,b,c,d,e,f){x.debug.warn("函数【x.designtime.getTemplateByWorkflowNodeId】已过时了，可以使用新的函数【x.workflow.template.download】。"),x.workflow.template.download({toolbar:c,container:b,url:"/api/workflow.instance.getTemplateByWorkflowNodeId.aspx",nodeId:a,fectchExpectedActors:d,fectchFinishedActors:e,corporationId:"undefined"==typeof f?"":f.corporationId,projectId:"undefined"==typeof f?"":f.projectId})}},runtime:{viewWorkflowByWorkflowInstanceId:function(a,b){var c="/apps/pages/workflowplus/designer/v2/canvas.aspx?workflowInstanceId="+encodeURIComponent(a)+"&status=readonly";b?x.mask.getUrl(c):location.href=c},viewWorkflowByWorkflowNodeId:function(a,b){var c="/workflowplus/pages/workflow_view.aspx?nid="+encodeURIComponent(a);b?x.util.showModalDialog(c,Workflowplus.runtime.modalDialogWidth,Workflowplus.runtime.modalDialogHeight):location.href=c},viewContentByFlowInstanceId:function(){},viewContentByNodeId:function(a,b){var c="/workflowplus/pages/workflow_view_dispatch.aspx?nid="+a;b?x.util.showModalDialog(c,x.workflow.runtime.modalDialogWidth,x.workflow.runtime.modalDialogHeight):location.href=c},viewMyHistoryByFlowInstanceId:function(a,b){var c="/workflowplus/pages/workflow_query_done_all_node_list.aspx?fid="+a;b?x.util.showModalDialog(c,x.workflow.runtime.modalDialogWidth,x.workflow.runtime.modalDialogHeight):location.href=c},viewHistoryNodesByWorkflowInstanceId:function(a,b){if(!(a.indexOf("$")>-1||a.indexOf("{")>-1||a.indexOf("}")>-1||a.indexOf("$")>-1)){if("undefined"==typeof a||""===a)return void alert("必须填写【流程实例标识】。");"undefined"==typeof b||"undefined"==typeof b.id?x.cookies.add("workflow-runtime$viewHistoryNodesByWorkflowInstanceId$container","workflow-runtime$viewHistoryNodesByWorkflowInstanceId$container"):x.cookies.add("workflow-runtime$viewHistoryNodesByWorkflowInstanceId$container",b.id);var c='<?xml version="1.0" encoding="utf-8" ?>';c+="<request>",c+="<workflowInstanceId><![CDATA["+a+"]]></workflowInstanceId>",c+="</request>",x.net.xhr("/api/workflow.historyNode.findFinishedHistoryNodes.aspx?workflowInstanceId"+a,{callback:function(a){var b="",c=x.toJSON(a),d=c.ajaxStorage;b+='<table class="table-style table-full-border-style-table" style="width: 100%; margin-bottom: 4px;" >',b+="<tbody>",b+='<tr class="table-row-title" >',b+='<th style="width: 80px;">审批人</th>',b+="<th >审批意见</th>",b+='<th style="width: 120px;">审批时间</th>',b+="</tr>",d.each(function(a){b+='<tr class="table-row-normal" >',b+="<td>"+a.actorName+"</td>",b+="<td>"+a.idea+"</td>",b+="<td>"+x.date.create(a.finishedTime).toString("yyyy-MM-dd HH:mm:ss")+"</td>",b+="</tr>"}),b+="</tbody>",b+="</table>",""===x.cookies.find("workflow-runtime$viewHistoryNodesByWorkflowInstanceId$container")?$("#windowWorkflowHistoryNodesContainer").html(b):$(document.getElementById(x.cookies.find("workflow-runtime$viewHistoryNodesByWorkflowInstanceId$container"))).html(b)}})}},manageFlowByFlowInstanceId:function(a,b){var c="/workflowplus/pages/workflow_management_instance.aspx?fid="+a;b?x.util.showModalDialog(c,x.workflow.runtime.modalDialogWidth,x.workflow.runtime.modalDialogHeight):location.href=c},manageFlowByNodeId:function(a,b){var c="/workflowplus/pages/workflow_management_instance.aspx?nid="+a;b?x.util.showModalDialog(c,x.workflow.runtime.modalDialogWidth,x.workflow.runtime.modalDialogHeight):location.href=c}}},x.workflow.template={create:function(a){x.net.xhr("/api/workflow.template.create.aspx?type="+a.type,{callback:a.callback})},confirmCopy:function(a){x.net.xhr("/api/workflow.template.copy.aspx?id="+a.id,{callback:a.callback})},confirmDelete:function(a){null!==a.ids&&confirm("确定删除？")&&x.net.xhr("/api/workflow.template.delete.aspx?ids="+a.ids,{callback:a.callback})},download:function(a){var b="undefined"==typeof a.toolbar?"":a.toolbar,c='<?xml version="1.0" encoding="utf-8" ?>';c+="<request>","undefined"!=typeof a.id&&(c+="<id><![CDATA["+a.id+"]]></id>"),"undefined"!=typeof a.nodeId&&(c+="<nodeId><![CDATA["+a.nodeId+"]]></nodeId>"),"undefined"!=typeof a.fectchExpectedActors&&(c+="<fectchExpectedActors><![CDATA["+a.fectchExpectedActors+"]]></fectchExpectedActors>"),"undefined"!=typeof a.fectchFinishedActors&&(c+="<fectchFinishedActors><![CDATA["+a.fectchFinishedActors+"]]></fectchFinishedActors>"),"undefined"!=typeof a.corporationId&&(c+="<corporationId><![CDATA["+a.corporationId+"]]></corporationId>"),"undefined"!=typeof a.projectId&&(c+="<projectId><![CDATA["+a.projectId+"]]></projectId>"),c+="</request>",$("#workflow-template-toolbar").prepend(b),x.net.xhr(a.url,c,{waitingType:"mini",waitingMessage:i18n.strings.msg_net_waiting_query_tip_text,callback:function(b){var c="",d=x.toJSON(b).data;c+='<input id="workflow-template-id" name="workflow-template-id" type="hidden" value="'+d.id+'" />',c+='<input id="workflow-template-corporationIds" name="workflow-template-corporationIds" type="hidden" value="" />',c+='<input id="workflow-template-projectIds" name="workflow-template-projectIds" type="hidden" value="" />',c+='<input id="workflow-template-startActorId" name="workflow-template-startActorId" type="hidden" value="'+d.startActorId+'" />',c+='<input id="workflow-template-startActorName" name="workflow-template-startActorName" type="hidden" value="'+d.startActorName+'" />',c+='<input id="workflow-template-startRoleId" name="workflow-template-startRoleId" type="hidden" value="'+d.startRoleId+'" />',c+='<input id="workflow-template-startRoleName" name="workflow-template-startRoleName" type="hidden" value="'+d.startRoleName+'" />',c+='<input id="workflow-template-name" name="workflow-template-name" type="hidden" value="'+d.name+'" />',c+='<input id="workflow-template-type" name="workflow-template-type" type="hidden" value="'+d.type+'" />',c+='<input id="workflow-template-tags" name="workflow-template-tags" type="hidden" value="'+d.tags+'" />',c+='<input id="workflow-template-entitySchemaName" name="workflow-template-entitySchemaName" type="hidden" value="'+d.entitySchemaName+'" />',c+='<input id="workflow-template-entityMetaData" name="workflow-template-entityMetaData" type="hidden" value="'+d.entityMetaData+'" />',c+='<input id="workflow-template-entityClass" name="workflow-template-entityClass" type="hidden" value="'+d.entityClass+'" />',c+='<input id="workflow-template-viewer" name="workflow-template-viewer" type="hidden" value="'+d.viewer+'" />',c+='<input id="workflow-template-policy" name="workflow-template-policy" type="hidden" value="'+x.encoding.html.encode(d.policy)+'" />',c+='<input id="workflow-template-config" name="workflow-template-config" type="hidden" value="'+x.encoding.html.encode(d.config)+'" />',c+='<input id="workflow-template-remark" name="workflow-template-remark" type="hidden" value="'+x.encoding.html.encode(d.remark)+'" />',c+='<input id="workflow-template-disabled" name="workflow-template-disabled" type="hidden" value="'+d.disabled+'" />',c+='<input id="workflow-template-orderId" name="workflow-template-orderId" type="hidden" value="'+d.orderId+'" />',c+='<input id="workflow-template-updateDate" name="workflow-template-updateDate" type="hidden" value="'+d.updateDateView+'" />',"1"===x.dom("#workflow-displayCompactTemplate").val()?c+='<table class="table-style" style="width:100%;" >':(c+='<table class="table-style border-4" style="width:100%" >',c+='<tr id="workflowTemplateHeaderRow" >',c+='<td class="table-header" >',c+='<div class="float-right" >',c+=x.workflow.designtime.templateToolbar,c+="</div>",c+='流程[<span id="templateName">'+d.name+'</span>]<div class="clear"></div>',c+="</td>",c+="</tr>"),c+="<tr>",c+='<td class="table-body" >',c+='<table id="workflow_container" class="table-style" style="width:100%" >',c+='<tr id="workflowTemplateTitleRow" class="table-row-title" >',c+='<td style="width:40px;" title="节点" >&nbsp;</td>',c+='<td style="width:100px;" >节点名</td>',c+="<td >执行人</td>",c+='<td style="width:80px;" title="下一步骤" ><i class="fa fa-random"></i></td>',c+='<td style="width:60px;" title="执行方式" ><i class="fa fa-users"></i></td>',c+='<td style="width:40px;" title="时限" ><i class="fa fa-clock-o"></i></td>',c+='<td style="width:30px;" title="编辑" ><i class="fa fa-edit"></i></td>',c+='<td style="width:30px;" title="上移" ><i class="fa fa-arrow-up"></i></td>',c+='<td style="width:30px;" title="下移" ><i class="fa fa-arrow-down"></i></td>',c+='<td style="width:30px;" title="删除" ><i class="fa fa-times"></i></td>',c+="</tr>",x.each(d.activities,function(b,e){c+="1"===x.dom("#workflow-displayCompactTemplate").val()&&-1===a.url.indexOf("/api/workflow.template.findOne.aspx")&&"1"===x.dom("#workflow-hiddenTemplateTableFooter").val()&&d.activities.length===b+1?"1"===$("#workflow-higthlightTemplateCurrentNode").val()?'<tr id="'+e.id+'" class="table-row-normal-transparent workflow-node '+(1===e.status?"workflow-node-current":"")+'" style="background-color:#fcffca;" >':'<tr id="'+e.id+'" class="table-row-normal-transparent workflow-node '+(1===e.status?"workflow-node-current":"")+'" >':"1"===$("#workflow-higthlightTemplateCurrentNode").val()?'<tr id="'+e.id+'" class="table-row-normal workflow-node '+(1===e.status?"workflow-node-current":"")+'" style="background-color:#fcffca;" >':'<tr id="'+e.id+'" class="table-row-normal workflow-node '+(1===e.status?"workflow-node-current":"")+'" >',c+="<td></td>",c+="<td>",c+='<span id="'+e.id+'_nodeName" >'+e.name+"</span>",c+='<input id="'+e.id+'_id" type="hidden" value="'+x.isUndefined(e.id,"")+'" />',c+='<input id="'+e.id+'_name" type="hidden" value="'+x.isUndefined(e.name,"")+'" />',c+='<input id="'+e.id+'_type" type="hidden" value="'+x.isUndefined(e.type,"")+'" />',c+='<input id="'+e.id+'_actorScope" type="hidden" value="'+x.isUndefined(e.actorScope,"")+'" />',c+='<input id="'+e.id+'_actorDescription" type="hidden" value="'+x.isUndefined(e.actorDescription,"")+'" />',c+='<input id="'+e.id+'_actorCounter" type="hidden" value="'+x.isUndefined(e.actorCounter,"")+'" />',c+='<input id="'+e.id+'_actorMethod" type="hidden" value="'+x.isUndefined(e.actorMethod,"")+'" />',c+='<input id="'+e.id+'_editor" type="hidden" value="'+x.isUndefined(e.editor,"")+'" />',c+='<input id="'+e.id+'_handler" type="hidden" value="'+x.isUndefined(e.handler,"")+'" />',c+='<input id="'+e.id+'_backNodes" type="hidden" value="'+x.isUndefined(e.backNodes,"")+'" />',c+='<input id="'+e.id+'_forwardNodes" type="hidden" value="'+x.isUndefined(e.forwardNodes,"")+'" />',c+='<input id="'+e.id+'_commissionActors" type="hidden" value="'+x.isUndefined(e.commissionActors,"")+'" />',c+='<input id="'+e.id+'_timelimit" type="hidden" value="'+x.isUndefined(e.timelimit,"")+'" />',c+='<input id="'+e.id+'_filterActors" type="hidden" value="'+x.isUndefined(e.filterActors,"")+'" />',c+='<input id="'+e.id+'_sendAlertTask" type="hidden" value="'+x.isUndefined(e.sendAlertTask,"")+'" />',c+='<input id="'+e.id+'_policy" type="hidden" value="'+(x.isUndefined(e.policy)?"":x.encoding.html.encode(e.policy))+'" />',c+='<input id="'+e.id+'_remark" type="hidden" value="'+(x.isUndefined(e.remark)?"":x.encoding.html.encode(e.remark))+'" />',c+='<input id="'+e.id+'_status" type="hidden" value="'+x.isUndefined(e.status,"")+'" />',c+='<input id="'+e.id+'_positionX" type="hidden" value="'+x.isUndefined(e.positionX,"")+'" />',c+='<input id="'+e.id+'_positionY" type="hidden" value="'+x.isUndefined(e.positionY,"")+'" />',c+='<input id="'+e.id+'_repeatDirection" type="hidden" value="'+x.isUndefined(e.repeatDirection,"")+'" />',c+='<input id="'+e.id+'_zIndex" type="hidden" value="'+x.isUndefined(e.zIndex,"0")+'" />',c+='<input id="'+e.id+'_canEdit" type="hidden" value="'+x.isUndefined(e.canEdit,"0")+'" />',c+='<input id="'+e.id+'_canMove" type="hidden" value="'+x.isUndefined(e.canMove,"0")+'" />',c+='<input id="'+e.id+'_canDelete" type="hidden" value="'+x.isUndefined(e.canDelete,"0")+'" />',c+='<input id="'+e.id+'_canUploadFile" type="hidden" value="'+x.isUndefined(e.canUploadFile,"0")+'" />',c+='<input id="'+e.id+'_radiation" type="hidden" value="'+("undefined"==typeof e.switcher||"undefined"==typeof e.switcher.radiation?"0":e.switcher.radiation)+'" />',c+='<input id="'+e.id+'_exits" type="hidden" value="'+("undefined"==typeof e.switcher||"undefined"==typeof e.switcher.exits?"[]":x.encoding.html.encode(e.switcher.exits))+'" />',c+="</td>",c+="<td>",c+='<span id="'+e.id+'_actorDescription" >'+("undefined"==typeof e.actorDescription?"":e.actorDescription)+"</span>",c+=""===e.expectedActors?'<span id="'+e.id+'_expectedActors" class="ajax-workflow-node-expected-actors-notfound" >(<label>未找到预计执行人.</label>)</span>':'<span id="'+e.id+'_expectedActors" class="ajax-workflow-node-expected-actors" >(<label><strong>预计执行人:</strong>'+("undefined"==typeof e.expectedActors?"":e.expectedActors)+"</label>)</span>",c+="</td>",c+="<td></td>",c+="<td>"+x.isUndefined(e.actorMethod,"并审")+"</td>",c+="<td>"+x.isUndefined(e.timelimit,"0")+"</td>",c+='<td><a href="#" >编辑</a></td>',c+='<td><a href="#" >上移</a></td>',c+='<td><a href="#" >下移</a></td>',c+='<td><a href="#" >删除</a></td>',c+="</tr>"}),(a.url.indexOf("/api/workflow.template.findOne.aspx")>-1||"1"!==x.dom("#workflow-hiddenTemplateTableFooter").val())&&(c+='<tr class="table-row-normal-transparent workflow-node-new" >',c+='<td colspan="6" style="text-align:left;" >',a.url.indexOf("/api/workflow.template.findOne.aspx")>-1&&(c+='<span style="padding:0 4px 0 0; font-weight:bold;" >发起角色:</span>',c+='<span id="workflow-template-startRoleText" style="padding:0 8px 0 0;" >'+d.startRoleName+"</span>",c+="<a href=\"javascript:x.workflow.instance.actor.getStartRoleWizard('"+d.startActorId+"');\" >编辑</a>"),c+="</td>",c+='<td colspan="4" style="text-align:right;" >',"1"!==x.dom("#workflow-hiddenTemplateTableFooter").val()&&(c+='<a href="javascript:x.workflow.node.create();" >新增节点</a>'),c+="</td>",c+="</tr>"),c+="</table>",c+="</td>",c+="</tr>",c+="1"===x.dom("#workflow-displayCompactTemplate").val()?"</table>":'<tr id="workflowTemplateFooterRow" ><td class="table-footer" ><img src="/resources/images/transparent.gif" alt="" style="height:18px" /></td></tr></table>',$(a.container).html(c),x.dom.features.bind(),x.workflow.template.setTemplateObject(d),x.workflow.template.setTemplateEntityMetaData(d.entityClass),x.workflow.node.sync(),"undefined"!=typeof a.callback&&a.callback()}})},getTemplateObject:function(){var a="";return a+="{",a+='"id":"'+x.dom("#workflow-template-id").val()+'", ',a+='"corporationIds":"'+x.dom("#workflow-template-corporationIds").val()+'", ',a+='"projectIds":"'+x.dom("#workflow-template-projectIds").val()+'", ',a+='"startActorId":"'+x.dom("#workflow-template-startActorId").val()+'", ',a+='"startActorName":"'+x.dom("#workflow-template-startActorName").val()+'", ',a+='"startRoleId":"'+x.dom("#workflow-template-startRoleId").val()+'", ',a+='"startRoleName":"'+x.dom("#workflow-template-startRoleName").val()+'", ',a+='"name":"'+x.dom("#workflow-template-name").val()+'", ',a+='"type":"'+x.dom("#workflow-template-type").val()+'", ',a+='"entitySchemaName":"'+x.dom("#workflow-template-entitySchemaName").val()+'", ',a+='"entityMetaData":"'+x.dom("#workflow-template-entityMetaData").val()+'", ',a+='"entityClass":"'+x.dom("#workflow-template-entityClass").val()+'", ',a+='"viewer":"'+x.dom("#workflow-template-viewer").val()+'", ',a+='"policy":"'+x.encoding.html.encode(x.dom("#workflow-template-policy").val())+'", ',a+='"config":"'+x.encoding.html.encode(x.dom("#workflow-template-config").val())+'", ',a+='"remark":"'+x.encoding.html.encode(x.dom("#workflow-template-remark").val())+'", ',a+='"disabled":"'+x.dom("#workflow-template-disabled").val()+'" ',a+="}",x.toJSON(a)},setTemplateObject:function(a){x.dom("#workflow-template-id").val(a.id),x.dom("#workflow-template-name").val(a.name),x.dom("#workflow-template-type").val(a.type),x.dom("#workflow-template-entityClass").val(a.entityClass),x.dom("#workflow-template-viewer").val(a.viewer),x.dom("#workflow-template-policy").val(x.encoding.html.decode(a.policy)),x.dom("#workflow-template-config").val(x.encoding.html.decode(a.config)),x.dom("#workflow-template-remark").val(x.encoding.html.decode(a.remark)),x.dom("#workflow-template-disabled").val(a.disabled)},setTemplateCorporationIds:function(a){x.dom("#workflow-template-corporationIds").val(a)},setTemplateProjectIds:function(a){x.dom("#workflow-template-projectIds").val(a)},setTemplateEntityMetaData:function(a,b){x.dom("#workflow-template-entityClass").val(a),"undefined"==typeof b&&x.dom("#workflow-template-entitySchemaName").val(b),x.net.xhr("/api/kernel.entities.metaData.findAllByEntityClassName.aspx?entityClassName="+a,"",{callback:function(a){var b="",c=x.toJSON(a).data;x.each(c,function(a,c){b+=c.fieldName+","}),","===b.substr(b.length-1,1)&&(b=b.substr(0,b.length-1)),document.getElementById("workflow-template-entityMetaData").value=b}})},getTemplategetInternalMetaData:function(){var a=x.dom("#workflow-template-config").val();if(""==a)return[];var b=x.toJSON(a);return"undefined"==typeof b.metaData?[]:b.metaData},verify:function(){for(var a=x.workflow.settings,b=$(a.workflowNodeSelector),c=!1,d=0;d<b.length;d++){var e=b[d].childNodes[1].childNodes[b[d].childNodes[1].childNodes.length-1].value;if(""!==e)for(var f=x.toJSON(e),g=0;g<f.length;g++){c=!1;for(var h=0;h<b.length;h++)f[g].toNodeId===b[d].childNodes[1].childNodes[1].value&&(c=!0)}}},serialize:function(){var a='<?xml version="1.0" encoding="utf-8"?>\r\n',b=x.workflow.settings,c=$(b.workflowNodeSelector);return a+="<workflow "+x.workflow.template.serializeTemplateAttributes(x.workflow.template.getTemplateObject())+" >",x.workflow.template.verify(),a+=x.workflow.template.serializeDesigntimeXml(c),a+=x.workflow.template.serializeRuntimeXml(c),a+="</workflow>"},serializeTemplateAttributes:function(a){var b='id="'+a.id+'" startActorId="'+a.startActorId+'" startActorName="'+a.startActorName+'" startRoleId="'+a.startRoleId+'" startRoleName="'+a.startRoleName+'" name="'+a.name+'" type="'+a.type+'" entitySchemaName="'+("undefined"==typeof a.entitySchemaName?"":a.entitySchemaName)+'" entityMetaData="'+("undefined"==typeof a.entityMetaData?"":a.entityMetaData)+'" entityClass="'+("undefined"==typeof a.entityClass?"":a.entityClass)+'" viewer="'+("undefined"==typeof a.viewer?"":x.encoding.html.encode(a.viewer))+'" policy="'+("undefined"==typeof a.policy?"":a.policy)+'" config="'+("undefined"==typeof a.config?"":a.config)+'" remark="'+("undefined"==typeof a.remark?"":a.remark)+'" disabled="'+("undefined"==typeof a.disabled?"":a.disabled)+'" ';return b},serializeDesigntimeXml:function(a){var b=30,c=200,d=1,e=1,f=150,g=75,h=-15,i="<designtime>";return a.each(function(j,k){d<a.length?(i+=x.workflow.template.serializeDesigntimeActivityXml(k,{index:j,type:1===d?"starter":k.childNodes[1].childNodes[3].value,idPrefix:1===d?"sn_":"nn_",positionX:1===d?b-42+g:b+f*(d-1)+10,positionY:c-15,zIndex:e++}),"[]"===k.childNodes[1].childNodes[k.childNodes[1].childNodes.length-1].value?i+=x.workflow.template.serializeDesigntimeRuleXml(k,{index:d,type:"straightline",beginActivityId:k.childNodes[1].childNodes[1].value,beginActivityName:k.childNodes[1].childNodes[2].value,endActivityId:a[j+1].childNodes[1].childNodes[1].value,endActivityName:a[j+1].childNodes[1].childNodes[2].value,beginPointX:b+g,beginPointY:c,endPointX:b+f,endPointY:c,zIndex:e++}):(exits=x.toJSON(k.childNodes[1].childNodes[k.childNodes[1].childNodes.length-1].value),x.each(exits,function(a,h){i+=x.workflow.template.serializeDesigntimeRuleXml(k,{index:d+"_"+(a+1),type:"foldline",condition:h.friendlyCondition,beginActivityId:k.childNodes[1].childNodes[1].value,beginActivityName:k.childNodes[1].childNodes[2].value,endActivityId:h.toNodeId,endActivityName:x.workflow.node.attribute(h.toNodeId,"name"),beginPointX:b+g,beginPointY:c,endPointX:b+f,endPointY:c,zIndex:e++})})),d++):i+=x.workflow.template.serializeDesigntimeActivityXml(k,{index:j,type:"terminator",idPrefix:"en_",positionX:b+f*(d-1)+h,positionY:c-15,zIndex:e})}),i+="</designtime>"},serializeDesigntimeActivityXml:function(a,b){var c='<activity id="'+("starter"===b.type?"sn_0":b.idPrefix+b.index)+'" name="'+a.childNodes[1].childNodes[2].value+'" type="'+b.type+'" actorScope="'+("starter"===b.type?"initiator#00000000-0000-0000-0000-000000000000":a.childNodes[1].childNodes[4].value)+'" actorDescription="'+("starter"===b.type?"流程发起人":a.childNodes[1].childNodes[5].value)+'" actorCounter="'+("starter"===b.type?"1":a.childNodes[1].childNodes[6].value)+'" actorMethod="'+("starter"===b.type?"提交":a.childNodes[1].childNodes[7].value)+'" editor="'+a.childNodes[1].childNodes[8].value+'" handler="'+a.childNodes[1].childNodes[9].value+'" backNodes="'+a.childNodes[1].childNodes[10].value+'" forwardNodes="'+a.childNodes[1].childNodes[11].value+'" commissionActors="'+a.childNodes[1].childNodes[12].value+'" timelimit="'+a.childNodes[1].childNodes[13].value+'" filterActors="'+a.childNodes[1].childNodes[14].value+'" sendAlertTask="'+a.childNodes[1].childNodes[15].value+'" policy="'+x.string.trim(JSON.stringify(a.childNodes[1].childNodes[16].value).replace(/"/g,"##"),"##")+'" remark="'+a.childNodes[1].childNodes[17].value+'" status="'+a.childNodes[1].childNodes[18].value+'" positionX="'+b.positionX+'" positionY="'+b.positionY+'" repeatDirection="'+a.childNodes[1].childNodes[21].value+'" zIndex="'+b.zIndex+'" canEdit="'+a.childNodes[1].childNodes[23].value+'" canMove="'+a.childNodes[1].childNodes[24].value+'" canDelete="'+a.childNodes[1].childNodes[25].value+'" canUploadFile="'+a.childNodes[1].childNodes[26].value+'" radiation="'+a.childNodes[1].childNodes[a.childNodes[1].childNodes.length-2].value+'" />';return c},serializeDesigntimeRuleXml:function(a,b){return'<rule id="rule_'+b.index+'" name="规则'+b.index+'" type="'+b.type+'" condition="'+b.condition+'" beginActivityId="'+b.beginActivityId+'" beginActivityName="'+b.beginActivityName+'" endActivityId="'+b.endActivityId+'" endActivityName="'+b.endActivityName+'" beginPointX="'+b.beginPointX+'" beginPointY="'+b.beginPointY+'" endPointX="'+b.endPointX+'" endPointY="'+b.endPointY+'" turnPoint1X="'+("straightline"===b.type?0:b.turnPoint1X)+'" turnPoint1Y="'+("straightline"===b.type?0:b.turnPoint1Y)+'" turnPoint2X="'+("straightline"===b.type?0:b.turnPoint2X)+'" turnPoint2Y="'+("straightline"===b.type?0:b.turnPoint2Y)+'" zIndex="'+b.zIndex+'" />'},serializeRuntimeXml:function(a){var b="<runtime>",c=1,d=[],e=[];return a.each(function(f,g){e[c]=[],1===c?(b+=x.workflow.template.serializeRuntimeNodeXml(g,{type:"starter",idPrefix:"sn_",index:f}),"[]"===g.childNodes[1].childNodes[g.childNodes[1].childNodes.length-1].value?b+=x.workflow.template.serializeRuntimeRouteXml({index:c,from:(0===f?"sn_":"nn_")+f,fromType:"node",to:(c+1===a.length?"en_":"nn_")+c,toType:"node"}):(exits=x.toJSON(g.childNodes[1].childNodes[g.childNodes[1].childNodes.length-1].value),b+=x.workflow.template.serializeRuntimeRouteXml({index:f+"_switcher",from:(0===f?"sn_":"nn_")+f,fromType:"node",to:"switcher_"+c,toType:"switcher"}),b+=x.workflow.template.serializeRuntimeSwitcherXml(exits,{index:c,radiation:0,field:"",canEdit:0,canMove:0,remark:""}),b+=x.workflow.template.serializeRuntimeRouteXml({index:c+"_1",from:"switcher_"+c+"_exit_1",fromType:"switcher_exit",to:"nn_"+(f+1),toType:"node"}),x.each(exits,function(a,f){a>0&&(d[f.toNodeId]=f.toNodeId,e[c][f.toNodeId]=f.toNodeId,b+=x.workflow.template.serializeRuntimeRouteXml({index:c+"_"+(a+1),from:"switcher_"+c+"_exit_"+(a+1),fromType:"switcher_exit",to:"collector_"+x.workflow.node.nodeIndex(f.toNodeId),toType:"collector"}))})),c++):c<a.length?("undefined"!=typeof d["nn_"+f]&&(b+=x.workflow.template.serializeRuntimeCollectorXml({index:f,condition:!0,canEdit:0,remark:""}),b+=x.workflow.template.serializeRuntimeRouteXml({index:f+"_collector",from:"collector_"+f,fromType:"collector",to:"nn_"+f,toType:"node"})),b+=x.workflow.template.serializeRuntimeNodeXml(g,{type:"node",idPrefix:"nn_",index:f}),"[]"===g.childNodes[1].childNodes[g.childNodes[1].childNodes.length-1].value?b+=x.workflow.template.serializeRuntimeRouteXml("undefined"==typeof d["nn_"+c]&&"undefined"==typeof d["en_"+c]?{index:c,from:(0===f?"sn_":"nn_")+f,fromType:"node",to:(c+1===a.length?"en_":"nn_")+c,toType:"node"}:{index:c,from:(0===f?"sn_":"nn_")+f,fromType:"node",to:"collector_"+c,toType:"collector"}):(exits=x.toJSON(g.childNodes[1].childNodes[g.childNodes[1].childNodes.length-1].value),b+=x.workflow.template.serializeRuntimeRouteXml({index:f+"_switcher",from:(0===f?"sn_":"nn_")+f,fromType:"node",to:"switcher_"+c,toType:"switcher"}),b+=x.workflow.template.serializeRuntimeSwitcherXml(exits,{index:c,radiation:0,field:"",canEdit:0,canMove:0,remark:""}),x.each(exits,function(a,e){a>0&&(d[e.toNodeId]=e.toNodeId,b+=x.workflow.template.serializeRuntimeRouteXml({index:c+"_"+(a+1),from:"switcher_"+c+"_exit_"+(a+1),fromType:"switcher_exit",to:"collector_"+x.workflow.node.nodeIndex(e.toNodeId),toType:"collector"}))}),b+=x.workflow.template.serializeRuntimeRouteXml({index:c+"_1",from:"switcher_"+c+"_exit_1",fromType:"switcher_exit",to:"nn_"+(f+1),toType:"node"})),c++):("undefined"!=typeof d["en_"+f]&&(b+=x.workflow.template.serializeRuntimeCollectorXml({index:f,condition:!0,canEdit:0,remark:""}),b+=x.workflow.template.serializeRuntimeRouteXml({index:f+"_collector",from:"collector_"+f,fromType:"collector",to:"en_"+f,toType:"node"})),b+=x.workflow.template.serializeRuntimeNodeXml(g,{type:"terminator",idPrefix:"en_",index:f}))}),b+="</runtime>"},serializeRuntimeNodeXml:function(a,b){var c="";return c+="<"+b.type+' id="'+b.idPrefix+b.index+'" name="'+a.childNodes[1].childNodes[2].value+'" remark="'+a.childNodes[1].childNodes[15].value+'" editor="'+a.childNodes[1].childNodes[8].value+'" handler="'+a.childNodes[1].childNodes[9].value+'" timelimit="'+a.childNodes[1].childNodes[13].value+'" filterActors="'+a.childNodes[1].childNodes[14].value+'" sendAlertTask="'+a.childNodes[1].childNodes[15].value+'" policy="'+x.string.trim(JSON.stringify(a.childNodes[1].childNodes[16].value).replace(/"/g,"##"),"##")+'" >',c+="starter"==b.type?'<actor scope="initiator" description="流程发起人" counter="1" method="提交" />':'<actor scope="'+a.childNodes[1].childNodes[4].value+'" description="'+a.childNodes[1].childNodes[5].value+'" counter="'+a.childNodes[1].childNodes[6].value+'" method="'+a.childNodes[1].childNodes[7].value+'" />',c+="<operation>",c+='<back cando="'+(""===a.childNodes[1].childNodes[10].value?"0":"1")+'" nodes="'+a.childNodes[1].childNodes[10].value+'" />',c+='<forward cando="'+(""===a.childNodes[1].childNodes[11].value?"0":"1")+'" nodes="'+a.childNodes[1].childNodes[11].value+'" />',c+='<commission cando="'+(""===a.childNodes[1].childNodes[12].value?"0":"1")+'" actors="'+a.childNodes[1].childNodes[12].value+'" />',c+="</operation>",c+="</"+b.type+">"},serializeRuntimeRouteXml:function(a){return'<route id="route_'+a.index+'" from="'+a.from+'" fromType="'+a.fromType+'" to="'+a.to+'" toType="'+a.toType+'" />'},serializeRuntimeSwitcherXml:function(a,b){var c='<switcher id="switcher_'+b.index+'" name="分支器'+b.index+'" radiation="'+b.radiation+'" field="'+b.field+'" canEdit="'+b.canEdit+'" canMove="'+b.canMove+'" remark="'+b.remark+'" >';return x.each(a,function(a,d){c+='<exit id="switcher_'+b.index+"_exit_"+(a+1)+'" condition="'+x.workflow.switcherExit.toSwitcherExitConditionText(d).replace(/"/g,"##")+'" />'}),c+="</switcher>"},serializeRuntimeCollectorXml:function(a){return'<collector id="collector_'+a.index+'" name="聚合'+a.index+'" condition="'+a.condition+'" canEdit="'+a.index+'" remark="'+a.remark+'" />'}},x.workflow.instance={pause:function(a){""!==a.id&&confirm("确定要暂停此流程吗？")&&x.net.xhr("/api/workflow.instance.pause.aspx?id="+a.id,{callback:a.callback})},resume:function(a){""!==a.id&&confirm("确定要恢复此流程吗？")&&x.net.xhr("/api/workflow.instance.resume.aspx?id="+a.id,{callback:a.callback})},abort:function(a){""!==a.id&&confirm("确定要中止此流程吗？ 流程一旦被中止，将无法恢复!")&&x.net.xhr("/api/workflow.instance.abort.aspx?id="+a.id,{callback:a.callback})},confirmDelete:function(a){null!==a.id&&confirm("确定删除？")&&x.net.xhr("/api/workflow.instance.delete.aspx?id="+a.id,{callback:a.callback})},actor:{getStartRoleWizard:function(a){x.ui.wizards.getWizard("workflow-startRole",{bindOptions:function(){},save_callback:function(){return $("#workflow-template-startRoleId").val($("#workflow-startRole-wizardValue").val()),$("#workflow-template-startRoleName").val($("#workflow-startRole-wizardText").val()),$("#workflow-template-startRoleText").html($("#workflow-startRole-wizardText").val()),x.workflow.node.getExpectedActors(),0
},create:function(){var a="";return a+='<div id="'+this.name+'" class="winodw-wizard-wrapper" style="width:260px; height:auto;" >',a+='<div class="winodw-wizard-toolbar" >',a+='<div class="winodw-wizard-toolbar-close">',a+='<a href="javascript:'+this.name+'.cancel();" title="关闭" ><i class="fa fa-close"></i></a>',a+="</div>",a+='<div class="float-left">',a+='<div class="winodw-wizard-toolbar-item" style="width:200px;" ><span>发起角色设置向导</span></div>',a+='<div class="clear"></div>',a+="</div>",a+='<div class="clear"></div>',a+="</div>",a+='<div id="workflow-startRole-wizardTableContainer" style="height:260px;" ></div>',a+='<div class="winodw-wizard-result-container form-inline text-right" >',a+='<label class="winodw-wizard-result-item-text" style="width:40px;" >角色</label> ',a+='<input id="workflow-startRole-wizardText" name="wizardText" type="text" value="'+$("#workflow-template-startRoleName").val()+'" class="winodw-wizard-result-item-input form-control input-sm" style="width:100px;" /> ',a+='<input id="workflow-startRole-wizardValue" name="wizardValue" type="hidden" value="'+$("#workflow-template-startRoleId").val()+'" />',a+='<a href="javascript:'+this.name+'.save();" class="btn btn-default btn-sm" >确定</a>',a+="</div>"}}),x.net.xhr("/api/membership.role.findAllByAccountId.aspx?accountId="+a,{waitingType:"mini",waitingMessage:i18n.strings.msg_net_waiting_query_tip_text,callback:function(a){var b="",c=0,d=x.toJSON(a),e=d.data;b+='<table class="table">',b+="<thead>",b+='<tr class="table-row-title">',b+="<th >名称</th>",b+="</tr>",b+="</thead>",b+="<tbody>",x.each(e,function(a,d){""!==d.value&&(classNameValue=c%2===0?"table-row-normal":"table-row-alternating",classNameValue+=c+1===e.length&&e.length>8?"-transparent":"",b+='<tr class="'+classNameValue+'">',b+="<td>",b+="<a href=\"javascript:$(#'workflow-startRole-wizardValue').val('"+d.id+"');x.form.query('workflow-startRole-wizardText').val('"+d.name+"'); void(0);\" >"+d.name+"</a></li>",b+="</td>",b+="</tr>",c++)}),b+="</tr>",b+="</tbody>",b+="</table>",$("#workflow-startRole-wizardTableContainer")[0].innerHTML=b}})}}},x.workflow.node={defaultPolicySetting:'{"setting":{"sendAlertTaskFormat":"","canRating":"0"},"entities":[]}',maskWrapper:x.ui.mask.newMaskWrapper("x-workflow-node-maskWrapper",{draggableHeight:504,draggableWidth:738}),currentIndex:0,attribute:function(a,b){var c=document.getElementById(a+"_"+b);return null===c?"":c.value},nodeIndex:function(a){var b=a.indexOf("_");return a.substr(b+1,a.length-b-1)},resetNodeId:function(a,b){for(var c=$(x.workflow.settings.workflowNodeSelector)[a-1],d=0;d<c.childNodes[1].childNodes.length;d++){var e=c.childNodes[1].childNodes[d].id,f=e.indexOf("_",4);c.childNodes[1].childNodes[d].id=b+"_"+e.substr(f+1,e.length-f-1)}},create:function(){for(var a,b=x.workflow.settings,c=$(b.workflowNodeSelector),d=c.length,e=1;100>e;e++){var f=!1;if(a="节点"+e,c.each(function(b,c){c.childNodes[1].childNodes[2].value===a&&(f=!0)}),!f)break}var g="";g+='<tr id="nn_'+d+'" class="table-row-normal workflow-node" >',g+="<td>"+(d>9?"":"0")+d+"</td>",g+="<td>",g+="<span>"+a+"</span>",g+='<input id="nn_'+d+'_id" type="hidden" value="nn_'+d+'" />',g+='<input id="nn_'+d+'_name" type="hidden" value="'+a+'" />',g+='<input id="nn_'+d+'_type" type="hidden" value="node" />',g+='<input id="nn_'+d+'_actorScope" type="hidden" value="" />',g+='<input id="nn_'+d+'_actorDescription" type="hidden" value="" />',g+='<input id="nn_'+d+'_actorCounter" type="hidden" value="1" />',g+='<input id="nn_'+d+'_actorMethod" type="hidden" value="并审" />',g+='<input id="nn_'+d+'_handler" type="hidden" value="" />',g+='<input id="nn_'+d+'_editor" type="hidden" value="" />',g+='<input id="nn_'+d+'_backNodes" type="hidden" value="" />',g+='<input id="nn_'+d+'_forwardNodes" type="hidden" value="" />',g+='<input id="nn_'+d+'_commissionActors" type="hidden" value="" />',g+='<input id="nn_'+d+'_timelimit" type="hidden" value="24" />',g+='<input id="nn_'+d+'_filterActors" type="hidden" value="1" />',g+='<input id="nn_'+d+'_sendAlertTask" type="hidden" value="1" />',g+='<input id="nn_'+d+'_policy" type="hidden" value="" />',g+='<input id="nn_'+d+'_remark" type="hidden" value="" />',g+='<input id="nn_'+d+'_status" type="hidden" value="" />',g+='<input id="nn_'+d+'_positionX" type="hidden" value="0" />',g+='<input id="nn_'+d+'_positionY" type="hidden" value="0" />',g+='<input id="nn_'+d+'_repeatDirection" type="hidden" value="None" />',g+='<input id="nn_'+d+'_zIndex" type="hidden" value="" />',g+='<input id="nn_'+d+'_canEdit" type="hidden" value="1" />',g+='<input id="nn_'+d+'_canMove" type="hidden" value="1" />',g+='<input id="nn_'+d+'_canDelete" type="hidden" value="1" />',g+='<input id="nn_'+d+'_canUploadFile" type="hidden" value="0" />',g+='<input id="nn_'+d+'_radiation" type="hidden" value="0" />',g+='<input id="nn_'+d+'_exits" type="hidden" value="[]" />',g+="</td>",g+="<td>",g+='<span id="nn_'+d+'_actorDescription" ></span>',g+="</td>",g+="<td></td>",g+="<td></td>",g+="<td></td>",g+='<td><a href="#">编辑</a></td>',g+='<td><a href="#">上移</td>',g+='<td><a href="#">下移</td>',g+='<td><a href="#">删除</td>',g+="</tr>","undefined"==typeof $(b.workflowNodeSelector+":last")[0]?(x.workflow.node.currentIndex=1,$(x.workflow.settings.workflowNodeNewSelector).before(g)):(d+=1,x.workflow.node.currentIndex=d,$(x.workflow.settings.workflowNodeNewSelector).before(g)),x.workflow.node.sync(),x.workflow.node.edit(d),x.workflow.node.maskWrapper.closeEvent=function(){var a=$(b.workflowNodeSelector);a.each(function(a,b){""===b.childNodes[1].childNodes[4].value&&x.workflow.node.remove(a+1)})}},sync:function(){for(var a=x.workflow.settings,b=$(a.workflowNodeSelector),c=0;c<b.length;c++){var d=b[c],e=c+1;d.id=0===c?"sn_0":c<b.length-1?"nn_"+c:"en_"+c,d.childNodes[1].childNodes[1].value=d.id,x.workflow.node.resetNodeId(e,d.id),d.childNodes[0].innerHTML=(e>9?"":"0")+e,0===c?(d.childNodes[1].childNodes[23].value="0",d.childNodes[6].innerHTML="1"===$(document.getElementById("workflow-administrator")).val()?'<a href="javascript:x.workflow.node.edit('+e+')" title="编辑"><i class="fa fa-edit"></i></a>':'<span class="gray-text" title="编辑" ><i class="fa fa-edit"></i></span>',d.childNodes[7].innerHTML='<span class="gray-text" title="上移" ><i class="fa fa-arrow-up"></i></span>',d.childNodes[8].innerHTML='<span class="gray-text" title="下移" ><i class="fa fa-arrow-down"></i></span>',d.childNodes[9].innerHTML='<span class="gray-text" title="删除" ><i class="fa fa-times"></i></span>'):"1"!==$("#workflow-administrator").val()&&"0"===$("#workflow-editableTemplate").val()?(d.childNodes[6].innerHTML='<span class="gray-text" title="编辑" ><i class="fa fa-edit"></i></span>',d.childNodes[7].innerHTML='<span class="gray-text" title="上移" ><i class="fa fa-arrow-up"></i></span>',d.childNodes[8].innerHTML='<span class="gray-text" title="下移" ><i class="fa fa-arrow-down"></i></span>',d.childNodes[9].innerHTML='<span class="gray-text" title="删除" ><i class="fa fa-times"></i></span>'):"1"!==$(document.getElementById("workflow-administrator")).val()&&Number(d.childNodes[1].childNodes[18].value)>0?(d.childNodes[6].innerHTML='<span class="gray-text" title="编辑" ><i class="fa fa-edit"></i></span>',d.childNodes[7].innerHTML='<span class="gray-text" title="上移" ><i class="fa fa-arrow-up"></i></span>',d.childNodes[8].innerHTML='<span class="gray-text" title="下移" ><i class="fa fa-arrow-down"></i></span>',d.childNodes[9].innerHTML='<span class="gray-text" title="删除" ><i class="fa fa-times"></i></span>'):(d.childNodes[6].innerHTML="1"===$(document.getElementById("workflow-administrator")).val()||"1"===d.childNodes[1].childNodes[23].value?'<a href="javascript:x.workflow.node.edit('+e+')" title="编辑" ><i class="fa fa-edit"></i></a>':'<span class="gray-text" title="编辑" ><i class="fa fa-edit"></i></span>',"1"===$(document.getElementById("workflow-administrator")).val()||"1"===d.childNodes[1].childNodes[24].value?(d.childNodes[7].innerHTML='<a href="javascript:x.workflow.node.move('+e+',\'up\')" title="上移" ><i class="fa fa-arrow-up"></i></a>',d.childNodes[8].innerHTML='<a href="javascript:x.workflow.node.move('+e+',\'down\');" title="下移" ><i class="fa fa-arrow-down"></i></a>'):(d.childNodes[7].innerHTML='<span class="gray-text" title="上移" ><i class="fa fa-arrow-up"></i></span>',d.childNodes[8].innerHTML='<span class="gray-text" title="下移" ><i class="fa fa-arrow-down"></i></span>'),d.childNodes[9].innerHTML="1"===$(document.getElementById("workflow-administrator")).val()||"1"===d.childNodes[1].childNodes[25].value?'<a href="javascript:x.workflow.node.remove('+e+');" title="删除" ><i class="fa fa-times"></i></a>':'<span class="gray-text" title="删除" ><i class="fa fa-times"></i></span>')}for(var c=0;c<b.length;c++){var d=b[c],e=c+1;if(c<b.length-1){d.childNodes[3].className="vertical-middle",d.childNodes[3].innerHTML="→"+(e+1>9?"":"0")+(e+1);var f=d.childNodes[1].childNodes[d.childNodes[1].childNodes.length-1];if(""!==f.value&&"[]"!==f.value){var g=x.toJSON(f.value),h="";x.each(g,function(a,c){b.each(function(a,b){c.toNodeId==b.childNodes[1].childNodes[1].value&&(h+="→"+(a+1>9?"":"0")+(a+1)+" ")})}),d.childNodes[3].innerHTML=h}}c==b.length-1&&(d.childNodes[1].childNodes[d.childNodes[1].childNodes.length-1].value="[]",d.childNodes[3].innerHTML="")}},edit:function(a){x.workflow.node.currentIndex=a;var b=x.workflow.settings,c=x.workflow.node.getNodeObject(a),d="";d+='<div id="workflow-node-name-'+c.id+'" class="winodw-wizard-wrapper" style="width:720px; height:auto;" >',d+='<div class="winodw-wizard-toolbar" >',d+='<div class="winodw-wizard-toolbar-close">',d+='<a href="javascript:x.workflow.node.maskWrapper.close();" title="关闭" ><i class="fa fa-close"></i></a>',d+="</div>",d+='<div class="float-left">',d+='<div class="winodw-wizard-toolbar-item"><span>编辑节点</span></div>',d+='<div class="clear"></div>',d+="</div>",d+='<div class="clear"></div>',d+="</div>",d+='<div class="x-ui-pkg-tabs-wrapper" style="height: 360px;">',d+='<div id="workflow-node-tabs-menu-wrapper" class="x-ui-pkg-tabs-menu-wrapper" >',d+='<ul class="x-ui-pkg-tabs-menu nav nav-tabs" >',d+='<li><a href="#workflow-node-tab-1">基本属性</a></li>',d+='<li><a href="#workflow-node-tab-2">高级属性</a></li>',d+='<li><a href="#workflow-node-tab-3">分支设置</a></li>',d+='<li><a href="#workflow-node-tab-4">跳转设置</a></li>',d+='<li><a href="#workflow-node-tab-5">转交设置</a></li>',d+='<li><a href="#workflow-node-tab-6">策略设置</a></li>',d+="</ul>",d+="</div>",d+='<div class="x-ui-pkg-tabs-container" >',d+='<h2 class="x-ui-pkg-tabs-container-head-hidden"><a id="workflow-node-tab-1" name="workflow-node-tab-1" >基本属性</a></h2>',d+='<table style="width:100%;">',d+="<tr>",d+='<td class="table-body-text" style="width:120px;">节点名称</td>',d+='<td colspan="3" class="table-body-input">',d+='<input id="workflow-node-id" name="workflow-node-id" type="hidden" value="'+("undefined"==typeof c.id?"":c.id)+'" />',d+='<input id="workflow-node-policy" name="workflow-node-policy" type="hidden" value="'+("undefined"==typeof c.id?"":c.policy)+'" />',d+='<input id="workflow-node-backNodes" name="workflow-node-backNodes" type="hidden" value="'+("undefined"==typeof c.backNodes?"":c.backNodes)+'" />',d+='<input id="workflow-node-forwardNodes" name="workflow-node-forwardNodes" type="hidden" value="'+("undefined"==typeof c.forwardNodes?"":c.forwardNodes)+'" />',d+='<input id="workflow-node-commissionActors" name="workflow-node-commissionActors" type="hidden" value="'+("undefined"==typeof c.commissionActors?"":c.commissionActors)+'" />',d+='<input id="workflow-node-name" name="workflow-node-name" type="text" class="form-control" style="width:200px;" value="'+("undefined"==typeof c.name?"":c.name)+'" />',d+="</td>",d+="</tr>",d+="<tr>",d+='<td class="table-body-text" >节点权限</td>',d+='<td colspan="3" class="table-body-input">',d+='<input id="workflow-node-canEdit" name="workflow-node-canEdit" type="checkbox" '+("undefined"!=typeof c.canEdit&&"1"===c.canEdit?'checked="checked"':"")+" /> 编辑 ",d+='<input id="workflow-node-canMove" name="workflow-node-canMove" type="checkbox" '+("undefined"!=typeof c.canMove&&"1"===c.canMove?'checked="checked"':"")+" /> 移动 ",d+='<input id="workflow-node-canDelete" name="workflow-node-canDelete" type="checkbox" '+("undefined"!=typeof c.canDelete&&"1"===c.canDelete?'checked="checked"':"")+" /> 删除 ",d+='<input id="workflow-node-canUploadFile" name="workflow-node-canUploadFile" type="checkbox" '+("undefined"!=typeof c.canUploadFile&&"1"===c.canUploadFile?'checked="checked"':"")+" /> 上传附件 ",d+='<input id="workflow-node-filterActors" name="workflow-node-filterActors" type="checkbox" '+("undefined"!=typeof c.filterActors&&"1"===c.filterActors?'checked="checked"':"")+" /> 过滤已执行用户 ",d+="</td>",d+="</tr>",d+="<tr>",d+='<td class="table-body-text">节点执行人</td>',d+='<td colspan="3" class="table-body-input">',d+='<textarea id="workflow-node-actorDescription" name="workflow-node-actorDescription" class="textarea-normal" style="width:520px;cursor:default;" >'+x.isUndefined(c.actorDescription,"")+"</textarea><br />",d+='<input id="workflow-node-actorScope" name="workflow-node-actorScope" type="hidden" value="'+x.isUndefined(c.actorScope,"")+'" />',d+='<input id="node-actorCounter" name="node-actorCounter" type="hidden" value="'+x.isUndefined(c.actorCounter,"")+'" />',d+='<div class="text-right" style="width:520px;" > ',d+='<a href="javascript:x.workflow.node.showActorWizard();" >编辑</a>',d+="</div> ",d+="</td>",d+="</tr>",d+="<tr>",d+='<td class="table-body-text">备注</td>',d+='<td colspan="3" class="table-body-input">',d+='<textarea id="workflow-node-remark" name="workflow-node-remark" type="text" class="textarea-normal" style="width:520px; height:40px;" >'+(x.isUndefined(c.remark)?"":x.encoding.html.encode(c.remark))+"</textarea>",d+="</tr>",d+="<tr>",d+='<td class="table-body-text">执行方式</td>',d+='<td class="table-body-input">',d+='<input id="workflow-node-actorMethod" name="workflow-node-actorMethod" x-dom-feature="combobox" x-dom-combobox-data="'+(null===document.getElementById("workflow-nodeActorMethods")?b.workflowNodeActorMethods:$("#workflow-nodeActorMethods").val())+'" x-dom-topOffset="-1" selectedText="'+("undefined"==typeof c.actorMethod?"审核":c.actorMethod)+'" value="'+("undefined"==typeof c.actorMethod?"并审":c.actorMethod)+'" class="form-control" style="width:180px" />',d+="</td>",d+='<td class="table-body-text" style="width:120px;" >处理时限(小时)</td>',d+='<td class="table-body-input"><input id="workflow-node-timelimit" name="workflow-node-timelimit" x-dom-feature="number" type="text" class="form-control" style="width:120px;" value="'+("undefined"==typeof c.timelimit?"24":c.timelimit)+'" /></td>',d+="</tr>",d+="<tr >",d+='<td class="table-body-text" style="width:120px;" >提醒方式</td>',d+='<td colspan="3" class="table-body-input">',d+='<div class="vertical-middle" >',d+='<input id="workflow-node-sendAlertTask1" name="workflow-node-sendAlertTask1" type="checkbox" checked="checked" disabled="disabled" /> 待办事宜 ',d+="undefined"==typeof c.sendAlertTask||"2"!==c.sendAlertTask&&"3"!==c.sendAlertTask&&"7"!==c.sendAlertTask?'<input id="workflow-node-sendAlertTask2" name="workflow-node-sendAlertTask" type="checkbox" /> 邮件 ':'<input id="workflow-node-sendAlertTask2" name="workflow-node-sendAlertTask" type="checkbox" checked="checked" /> 邮件 ',d+="undefined"==typeof c.sendAlertTask||"4"!==c.sendAlertTask&&"5"!==c.sendAlertTask&&"7"!==c.sendAlertTask?'<input id="workflow-node-sendAlertTask4" name="workflow-node-sendAlertTask" type="checkbox" /> 短信 ':'<input id="workflow-node-sendAlertTask4" name="workflow-node-sendAlertTask" type="checkbox" checked="checked" /> 短信 ',d+="</div>",d+="</td>",d+="</tr>",d+="</table>",d+="</div>",d+='<div class="x-ui-pkg-tabs-container" >',d+='<h2 class="x-ui-pkg-tabs-container-head-hidden"><a id="workflow-node-tab-2" name="workflow-node-tab-2">高级属性</a></h2>',d+='<table style="width:100%;">',d+="<tr >",d+='<td class="table-body-text" style="width:120px" >编辑界面</td>',d+='<td class="table-body-input"><input id="workflow-node-editor" name="workflow-node-editor" type="text" class="form-control" style="width:95%;" value="'+("undefined"==typeof c.editor?"":c.editor)+'" /></td>',d+="</tr>",d+="<tr >",d+='<td class="table-body-text">处理器</td>',d+='<td class="table-body-input"><input id="workflow-node-handler" name="workflow-node-handler" type="text" class="form-control" style="width:95%;" value="'+("undefined"==typeof c.handler?"":c.handler)+'" /></td>',d+="</tr>",d+="<tr >",d+='<td class="table-body-text" >自定义待办提醒</td>',d+='<td class="table-body-input vertical-middle">',d+='<input id="workflow-node-policy-settings-sendAlertTaskFormat" name="workflow-node-settings$sendAlertTaskFormat" type="text" value="'+("undefined"==typeof c.policy.setting.sendAlertTaskFormat?"":c.policy.setting.sendAlertTaskFormat)+'" class="form-control" style="width:360px" />',d+="</td>",d+="</tr>",d+="<tr >",d+='<td class="table-body-text" style="width:120px" >评分功能</td>',d+='<td class="table-body-input vertical-middle">',d+='<input id="workflow-node-policy-settings-canRating" name="workflow-node-settings$canRating" type="checkbox" value="'+("undefined"==typeof c.policy.setting.canRating?"":c.policy.setting.canRating)+'" '+("1"===c.policy.setting.canRating?'checked="checked" ':"")+" /> 支持评分",d+="</td>",d+="</tr>",d+="</table>",d+="</div>",d+='<div class="x-ui-pkg-tabs-container" >',d+='<h2 class="x-ui-pkg-tabs-container-head-hidden"><a id="workflow-node-tab-3" name="workflow-node-tab-3">分支设置</a></h2>',d+='<table style="width:100%;">',d+="<tr >",d+='<td class="table-body-text" style="width:120px" >默认下一步骤</td>',d+='<td class="table-body-input"><span id="workflow-node-defaultSwitcherExit" name="workflow-node-workflow-node-defaultSwitcherExit" ></span></td>',d+="</tr>",d+="<tr >",d+='<td class="table-body-text">发散分支</td>',d+='<td class="table-body-input vertical-middle">',d+='<input id="workflow-node-switcher-radiation" name="workflow-node-switcher-radiation" type="checkbox" value="'+("undefined"==typeof c.switcher.radiation?"":c.switcher.radiation)+'" '+("1"===c.switcher.radiation?'checked="checked" ':"")+' disabled="disabled" /> ',d+='<span class="green-text" >允许工作流同时发散到所有分支</span>',d+="</td>",d+="</tr>",d+="<tr >",d+='<td class="table-body-text" style="width:120px" >分支出口条件</td>',d+='<td class="table-body-input">',d+='<div id="workflow-node-switcher-container" name="workflow-node-switcher-container" style="border:1px solid #ccc; width:460px; height:200px;" >',d+="</div> ",d+="</td>",d+="</tr>",d+="</table>",d+="</div>",d+='<div class="x-ui-pkg-tabs-container" >',d+='<h2 class="x-ui-pkg-tabs-container-head-hidden"><a name="workflow-node-tab-4" id="workflow-node-tab-4">跳转设置</a></h2>',d+='<table style="width:100%;">',d+="<tr >",d+='<td class="table-body-text" style="width:120px" >允许后退的节点</td>',d+='<td class="table-body-input vertical-middle"><div id="workflow-node-backNodes-container" name="workflow-node-backNodes-container" style="border:1px solid #ccc; width:460px; height:80px; padding:4px;" ></div></td>',d+="</tr>",d+="<tr >",d+="</tr>",d+="<tr >",d+='<td class="table-body-text">允许前进的节点</td>',d+='<td class="table-body-input vertical-middle"><div id="workflow-node-forwardNodes-container" name="workflow-node-forwardNodes-container" style="border:1px solid #ccc; width:460px; height:80px; padding:4px;" ></div></td>',d+="</tr>",d+="</table>",d+="</div>",d+='<div class="x-ui-pkg-tabs-container" >',d+='<h2 class="x-ui-pkg-tabs-container-head-hidden"><a name="workflow-node-tab-5" id="workflow-node-tab-5">转交设置</a></h2>',d+='<table style="width:100%;">',d+="<tr >",d+='<td class="table-body-text" style="width:120px" >允许转交的人员</td>',d+='<td class="table-body-input">',d+='<textarea id="workflow-node-commissionActorDescription" name="workflow-node-commissionActorDescription" class="textarea-normal" style="width:460px;height:80px;cursor:default;" ></textarea><br />',d+='<input id="workflow-node-commissionActors" name="workflow-node-commissionActors" type="hidden" value="'+("undefined"==typeof c.commissionActors?"":c.commissionActors)+'" />',d+='<div class="text-right" style="width:460px;" > ',d+="<a href=\"javascript:x.ui.wizards.getContactsWizard({targetViewName:'workflow-node-commissionActorDescription',targetValueName:'workflow-node-commissionActors', contactTypeText:'account'});\" >编辑</a>",d+="</div> ",d+="</td>",d+="</tr>",d+="<tr >",d+='<td class="table-body-text">允许任意转交</td>',d+='<td class="table-body-input vertical-middle">',d+='<input id="workflow-node-node-canCommissionEveryone" name="workflow-node-node-canCommissionEveryone" type="checkbox" '+("role#00000000-0000-0000-0000-000000000000#任意用户"===c.commissionActors?'checked="checked"':"")+"/> ",d+='<span class="green-text" >允许转交给任意用户审批</span>',d+="</td>",d+="</tr>",d+="</table>",d+="</div>",d+='<div class="x-ui-pkg-tabs-container" >',d+='<h2 class="x-ui-pkg-tabs-container-head-hidden"><a name="workflow-node-tab-6" id="workflow-node-tab-6">业务策略</a></h2>';var e=x.workflow.template.getTemplateObject();if(""===e.entityMetaData)d+='<div style="color:#a15300; background-color:#fcffca; padding: 0 0 0 10px;  border-bottom:1px solid #c75400; line-height:200%; font-size:12px;" >',d+="(*)未设置流程的业务对象属性。",d+="</div>";else{var f=e.entityMetaData.split(",");d+='<div id="workflow-node-policy-container" name="workflow-node-policy-container" style="height:200px;" >',d+='<table class="table-style" style="width:100%;" >',d+='<tr class="table-row-title">',d+="<td>字段</td>",d+='<td style="width:60px;">编辑</td>',d+='<td style="width:60px;">痕迹</td>',d+='<td style="width:60px;">隐藏</td>',d+="</tr>";for(var g=0;g<f.length;g++)d+='<tr class="table-row-normal workflow-node-policy-entity-metaData" >',d+="<td>"+f[g]+"</td>",d+='<td><input id="workflow-node-entity-'+f[g]+'$canEdit" type="checkbox" /></td>',d+='<td><input id="workflow-node-entity-'+f[g]+'$canTrace"  type="checkbox" /></td>',d+='<td><input id="workflow-node-entity-'+f[g]+'$canHide"  type="checkbox" /></td>',d+="</tr>";d+="</table>",d+="</div>"}d+="</div>",d+="</div>",d+='<div style="border-top:1px solid #ccc;padding:10px 20px 10px 0;" >',d+='<div class="float-right button-2font-wrapper" ><a id="btnCancel" href="javascript:void(0);" class="btn btn-default" >取消</a></div> ',d+='<div class="float-right button-2font-wrapper" style="margin-right:10px;" ><a id="btnOkey" href="javascript:void(0);" class="btn btn-default" >保存</a></div> ',d+='<div class="clear"></div>',d+="</div>",d+="</div>",x.ui.mask.getWindow({content:d},x.workflow.node.maskWrapper),$("#workflow-node-actorDescription").on("focus",function(){this.blur()}),x.workflow.node.html=d,x.workflow.node.setSwitcherExit(a,c.switcher.exits),x.workflow.node.setGotoNodeView(a,"back",c.backNodes),x.workflow.node.setGotoNodeView(a,"forward",c.forwardNodes),x.ui.wizards.setContactsView("workflow-node-commissionActorDescription",c.commissionActors),$(c.policy.entities).each(function(a,b){$("#workflow-node-entity-"+b.metaData+"-canEdit").size()>0&&($("#workflow-node-entity-"+b.metaData+"-canEdit")[0].checked="1"===b.canEdit?!0:!1,$("#workflow-node-entity-"+b.metaData+"-canTrace")[0].checked="1"===b.canTrace?!0:!1,$("#workflow-node-entity-"+b.metaData+"-canHide")[0].checked="1"===b.canHide?!0:!1)}),$(document.getElementById("workflow-node-node-canCommissionEveryone")).bind("click",function(){document.getElementById("workflow-node-node-canCommissionEveryone").checked?(document.getElementById("workflow-node-commissionActors").value="role#00000000-0000-0000-0000-000000000000#任意用户",document.getElementById("workflow-node-commissionActorDescription").value="任意用户"):(document.getElementById("workflow-node-commissionActors").value="",document.getElementById("workflow-node-commissionActorDescription").value="")}),$("#btnOkey").bind("click",function(){var a=x.workflow.node.getEditNodeObject();"undefined"!=typeof a&&(x.workflow.node.setNodeObject(a),$(document.getElementById("workflow-node-actorCounter")).val(a.actorCounter),x.workflow.node.maskWrapper.close(),x.workflow.node.getExpectedActors(a.id))}),$("#btnCancel").bind("click",function(){x.workflow.node.maskWrapper.close()}),x.page.goTop(),x.dom.features.bind(),x.ui.pkg.tabs.newTabs()},move:function(a,b){a-=1;var c,d=$("#nn_"+a)[0];if("undefined"==typeof d){if(d=$("#en_"+a)[0],"undefined"==typeof d)return;if("down"===b)return void alert("节点【"+d.childNodes[1].childNodes[2].value+"】为结束节点，禁止向下移动。")}var e='<tr class="'+d.className+'" style="'+d.style.cssText+'">'+d.innerHTML+"</tr>";if("up"===b){if(c=$("#sn_"+(a-1))[0],"undefined"!=typeof c)return void alert("节点【"+c.childNodes[1].childNodes[2].value+"】为开始节点，禁止移动。");c=$("#nn_"+(a-1))[0],"undefined"!=typeof c&&(0===Number(c.childNodes[1].childNodes[18].value)?(e='<tr class="'+c.className+'" style="'+c.style.cssText+'">'+d.innerHTML+"</tr>",$(c).before(e),$(c)[0].className=$(d)[0].className,$(d).remove()):alert("节点【"+c.childNodes[1].childNodes[2].value+"】已执行完成，禁止移动。"))}else if("down"===b){if(c=$("#nn_"+(a+1))[0],"undefined"==typeof c&&(c=$("#en_"+(a+1))[0]),"undefined"==typeof d||"undefined"==typeof c)return;c&&(0===Number(c.childNodes[1].childNodes[18].value)?(e='<tr class="'+c.className+'" style="'+c.style.cssText+'">'+d.innerHTML+"</tr>",$(c).after(e),$(c)[0].className=$(d)[0].className,$(d).remove()):alert("节点【"+c.childNodes[1].childNodes[2].value+"】已执行完成，禁止移动。"))}x.workflow.node.sync()},remove:function(a){var b=x.workflow.settings,c=$("#nn_"+(a-1))[0];if(c=c?c:$("#en_"+(a-1))[0]){var d=c.childNodes[1].childNodes[1].value,e=x.workflow.node.nodeIndex(d);x.workflow.node.currentIndex=0,$(c).remove();for(var f=$(b.workflowNodeSelector),g=0;g<f.length;g++){var h=f[g].childNodes[1].childNodes[f[g].childNodes[1].childNodes.length-1].value;if(""!==h){var i=x.toJSON(h);h="[";for(var j=0;j<i.length;j++)if(i[j].toNodeId!==d){var k=x.workflow.node.nodeIndex(i[j].toNodeId);h+="{",h+=e>k?'"toNodeId": "'+i[j].toNodeId+'",':'"toNodeId": "'+i[j].toNodeId.replace("_"+k,"_"+(k-1))+'",',h+='"friendlyCondition": "'+i[j].friendlyCondition+'",',h+='"condition":'+x.workflow.switcherExit.toSwitcherExitConditionText(i[j]),h+="},"}h=x.string.rtrim(h,","),h+="]",f[g].childNodes[1].childNodes[f[g].childNodes[1].childNodes.length-1].value=h}}}x.workflow.node.sync()},setSwitcherExit:function(a,b){var c="",d=$(x.workflow.settings.workflowNodeSelector);if("undefined"!=typeof d[a]){var e='<span class="blod-text" >'+d[a].childNodes[1].childNodes[2].value+"</span> ";$(document.getElementById("workflow-node-defaultSwitcherExit")).html(e)}c+='<table class="table-style" style="width:100%;" >',c+='<tr class="table-row-title" >',c+='<td style="width:80px;">出口名称</td>',c+="<td >出口条件</td>",c+='<td style="width:60px;">编辑</td>',c+='<td style="width:60px;">启用</td>',c+="</tr>";for(var f=0;f<d.length;f++)if(f>a-1){var g=null;x.each(b,function(a,b){d[f].childNodes[1].childNodes[1].value==b.toNodeId&&(g=b)}),c+='<tr class="table-row-normal" >',f==a?(c+="<td>",c+="<span>"+d[f].childNodes[1].childNodes[2].value+"</span>",c+='<input id="workflow-node-switcher-exit'+(f+1)+'-toNodeId" type="hidden" value="'+d[f].childNodes[1].childNodes[1].value+'" />',c+='<input id="workflow-node-switcher-exit'+(f+1)+'-condition" type="hidden" value="" />',c+='<input id="workflow-node-switcher-exit'+(f+1)+'-friendlyCondition" type="hidden" value="" />',c+="</td>",c+="<td></td>",c+='<td><span class="gray-text">编辑</span></td>',c+="<td>",c+='<span class="green-text">默认</span>',c+='<div class="hidden" ><input id="workflow-node-switcher-exit'+(f+1)+'" name="workflow-node-switcher-exit" type="checkbox" value="'+(f+1)+'" checked="checked" /></div>',c+="</td>"):(c+="<td>",c+="<span>"+d[f].childNodes[1].childNodes[2].value+"</span>",c+='<input id="workflow-node-switcher-exit'+(f+1)+'-toNodeId" type="hidden" value="'+d[f].childNodes[1].childNodes[1].value+'" />',c+='<input id="workflow-node-switcher-exit'+(f+1)+'-condition" type="hidden" value="'+(null===g?"[]":x.encoding.html.encode(x.workflow.switcherExit.toSwitcherExitConditionText(g)))+'" />',c+='<input id="workflow-node-switcher-exit'+(f+1)+'-friendlyCondition" type="hidden" value="'+(null===g?"":g.friendlyCondition)+'" />',c+="</td>",c+='<td><span id="workflow-node-switcher-exit'+(f+1)+'-friendlyConditionText" >'+(null===g?"":g.friendlyCondition)+"</span></td>",c+='<td><a href="javascript:x.workflow.switcherExit.edit('+(f+1)+');" >编辑</a></td>',c+='<td><input id="workflow-node-switcher-exit'+(f+1)+'" name="workflow-node-switcher-exit" disabled="disabled" type="checkbox" value="'+(f+1)+'" '+(null===g?"":'checked="checked" ')+"/></td>"),c+="</tr>"}c+="</table>",$("#workflow-node-switcher-container").html(c)},setGotoNodeView:function(a,b,c){for(var d="",e=$(x.workflow.settings.workflowNodeSelector),f=0;f<e.length;f++)("back"===b&&a-1>f||"forward"===b&&f>a-1)&&(d+='<input id="workflow-node-'+b+"Nodes-"+a+'" name="workflow-node-'+b+'Nodes" type="checkbox" value="'+e[f].childNodes[1].childNodes[2].value+'" '+(-1==c.indexOf(e[f].childNodes[1].childNodes[2].value)?"":'checked="checked" ')+" > <span>"+e[f].childNodes[1].childNodes[2].value+"</span> ");$("#workflow-node-"+b+"Nodes-container").html(d)},getEditNodeObject:function(){var a=$(document.getElementById("workflow-node-id")).val(),b=$(document.getElementById("workflow-node-name")).val();if(""===b)return void alert("【节点名称】不能为空。");var c=$(x.workflow.settings.workflowNodeSelector);for(h=0;h<c.length;h++)if(c[h].childNodes[1].childNodes[1].value!==a&&c[h].childNodes[1].childNodes[2].value===b)return void alert("节点名称【"+b+"】已存在。");var d=$(document.getElementById("workflow-node-actorMethod")).val(),e=0;e="会审"===d||"会签"===d||"审核"===d||"审批"===d||"批准"===d?0:"并审"===d||"校稿"===d?1:"抄送"===d||"传阅"===d?-1:-1;for(var f=0,g=[1,2,4],h=0;h<g.length;h++){var i=$(document.getElementById("workflow-node-sendAlertTask"+g[h]));"undefined"!=typeof i[0]&&i[0].checked&&(f+=g[h])}var j="{";j+='"setting":{',j+='"sendAlertTaskFormat":"'+$("#workflow-node-policy-settings-sendAlertTaskFormat").val()+'",',j+='"canRating":"'+($("#workflow-node-policy-settings-canRating")[0].checked?1:0)+'"},',j+='"entities":[';for(var k=$(".workflow-node-policy-entity-metaData"),h=0;h<k.size();h++){var l=k[h].childNodes[0].innerHTML;j+="{",j+='"metaData":"'+l+'",',j+='"canEdit":"'+($("#workflow-node-entity-"+l+"-canEdit")[0].checked?1:0)+'",',j+='"canTrace":"'+($("#workflow-node-entity-"+l+"-canTrace")[0].checked?1:0)+'",',j+='"canHide":"'+($("#workflow-node-entity-"+l+"-canHide")[0].checked?1:0)+'"',j+="}"+(h+1==k.size()?"":",")}j+="]",j+="}";for(var m="[",n=document.getElementsByName("workflow-node-switcher-exit"),h=0;h<n.length;h++)""===document.getElementById("workflow-node-switcher-exit"+n[h].value+"-condition").value&&(document.getElementById("workflow-node-switcher-exit"+n[h].value+"-condition").value="[]"),n[h].checked&&(m+="{",m+='"toNodeId":"'+document.getElementById("workflow-node-switcher-exit"+n[h].value+"-toNodeId").value+'", ',m+='"condition":'+document.getElementById("workflow-node-switcher-exit"+n[h].value+"-condition").value+", ",m+='"friendlyCondition":"'+document.getElementById("workflow-node-switcher-exit"+n[h].value+"-friendlyCondition").value+'" ',m+="},");","===m.substr(m.length-1,1)&&(m=m.substr(0,m.length-1)),m+="]";var o="";return o+="{",o+='"id":"'+$("#workflow-node-id").val()+'", ',o+='"name":"'+$(document.getElementById("workflow-node-name")).val()+'", ',o+='"actorScope":"'+$(document.getElementById("workflow-node-actorScope")).val()+'", ',o+='"actorDescription":"'+$(document.getElementById("workflow-node-actorDescription")).val()+'", ',o+='"actorCounter":"'+e+'", ',o+='"actorMethod":"'+$(document.getElementById("workflow-node-actorMethod")).val()+'", ',o+='"handler":"'+$(document.getElementById("workflow-node-handler")).val()+'", ',o+='"editor":"'+$(document.getElementById("workflow-node-editor")).val()+'", ',o+='"backNodes":"'+x.dom.util.checkbox.getValue("workflow-node-backNodes")+'", ',o+='"forwardNodes":"'+x.dom.util.checkbox.getValue("workflow-node-forwardNodes")+'", ',o+='"commissionActors":"'+$(document.getElementById("workflow-node-commissionActors")).val()+'", ',o+='"timelimit":"'+$(document.getElementById("workflow-node-timelimit")).val()+'", ',o+='"filterActors":"'+($(document.getElementById("workflow-node-filterActors"))[0].checked?"1":"0")+'", ',o+='"sendAlertTask":"'+f+'", ',o+='"policy":'+j+", ",o+='"remark":"'+x.encoding.html.encode($("#workflow-node-remark").val())+'", ',o+='"canEdit":"'+($(document.getElementById("workflow-node-canEdit"))[0].checked?"1":"0")+'", ',o+='"canMove":"'+($(document.getElementById("workflow-node-canMove"))[0].checked?"1":"0")+'", ',o+='"canDelete":"'+($(document.getElementById("workflow-node-canDelete"))[0].checked?"1":"0")+'", ',o+='"canUploadFile":"'+($(document.getElementById("workflow-node-canUploadFile"))[0].checked?"1":"0")+'", ',o+='"switcher":{',o+='"radiation":"'+($(document.getElementById("workflow-node-switcher-radiation"))[0].checked?"1":"0")+'",',o+='"exits":'+m+"}",o+="}",x.toJSON(o)
},getNodeObject:function(a){var b="undefined"==typeof a?x.workflow.node.currentIndex:a,c=$(x.workflow.settings.workflowNodeSelector),d=c[Number(b)-1],e=""===d.childNodes[1].childNodes[4].value?"initiator":d.childNodes[1].childNodes[4].value,f=""===d.childNodes[1].childNodes[5].value?"流程发起人":d.childNodes[1].childNodes[5].value,g=""===d.childNodes[1].childNodes[6].value?"1":d.childNodes[1].childNodes[6].value,h=""===d.childNodes[1].childNodes[7].value?"会审":d.childNodes[1].childNodes[7].value,i=""===d.childNodes[1].childNodes[8].value?"/workflowplus/console/workflow_running.aspx":d.childNodes[1].childNodes[8].value,j=""===d.childNodes[1].childNodes[9].value?"X3Platform.WorkflowPlus.Business.General.Transact":d.childNodes[1].childNodes[9].value;(""===d.childNodes[1].childNodes[16].value||"####"===d.childNodes[1].childNodes[16].value||"1"===d.childNodes[1].childNodes[16].value)&&(d.childNodes[1].childNodes[16].value=x.workflow.node.defaultPolicySetting);var k="";return k+="{",k+='"id":"'+d.childNodes[1].childNodes[1].value+'", ',k+='"name":"'+d.childNodes[1].childNodes[2].value+'", ',k+='"editor":"'+i+'", ',k+='"handler":"'+j+'", ',k+='"actorScope":"'+e+'", ',k+='"actorDescription":"'+f+'", ',k+='"actorCounter":"'+g+'", ',k+='"actorMethod":"'+h+'", ',k+='"canBack":"'+(""===d.childNodes[1].childNodes[10].value?0:1)+'", ',k+='"backNodes":"'+d.childNodes[1].childNodes[10].value+'", ',k+='"canForward":"'+(""===d.childNodes[1].childNodes[11].value?0:1)+'", ',k+='"forwardNodes":"'+d.childNodes[1].childNodes[11].value+'", ',k+='"canCommission":"'+(""===d.childNodes[1].childNodes[12].value?0:1)+'", ',k+='"commissionActors":"'+d.childNodes[1].childNodes[12].value+'", ',k+='"timelimit":"'+d.childNodes[1].childNodes[13].value+'", ',k+='"filterActors":"'+d.childNodes[1].childNodes[14].value+'", ',k+='"sendAlertTask":"'+d.childNodes[1].childNodes[15].value+'", ',k+='"policy":'+d.childNodes[1].childNodes[16].value+", ",k+='"remark":"'+x.encoding.html.encode(d.childNodes[1].childNodes[17].value)+'", ',k+='"canEdit":"'+d.childNodes[1].childNodes[23].value+'", ',k+='"canMove":"'+d.childNodes[1].childNodes[24].value+'", ',k+='"canDelete":"'+d.childNodes[1].childNodes[25].value+'", ',k+='"canUploadFile":"'+d.childNodes[1].childNodes[26].value+'", ',k+='"switcher":{',k+='"radiation":"'+d.childNodes[1].childNodes[d.childNodes[1].childNodes.length-2].value+'",',k+='"exits":'+d.childNodes[1].childNodes[d.childNodes[1].childNodes.length-1].value+"}",k+="}",x.toJSON(k)},setNodeObject:function(a,b){var c=x.workflow.settings,d="undefined"==typeof b?x.workflow.node.currentIndex:b,e=$(c.workflowNodeSelector),f=e[Number(d)-1];f.childNodes[1].childNodes[0].innerHTML=a.name,f.childNodes[1].childNodes[1].value=a.id,f.childNodes[1].childNodes[2].value=a.name,f.childNodes[1].childNodes[4].value=a.actorScope,f.childNodes[1].childNodes[5].value=a.actorDescription,f.childNodes[1].childNodes[6].value=a.actorCounter,f.childNodes[1].childNodes[7].value=a.actorMethod,f.childNodes[1].childNodes[8].value=a.editor,f.childNodes[1].childNodes[9].value=a.handler,f.childNodes[1].childNodes[10].value=a.backNodes,f.childNodes[1].childNodes[11].value=a.forwardNodes,f.childNodes[1].childNodes[12].value=a.commissionActors,f.childNodes[1].childNodes[13].value=a.timelimit,f.childNodes[1].childNodes[14].value=a.filterActors,f.childNodes[1].childNodes[15].value=a.sendAlertTask,f.childNodes[1].childNodes[16].value=JSON.stringify(a.policy),f.childNodes[1].childNodes[17].value=a.remark,f.childNodes[1].childNodes[23].value=a.canEdit,f.childNodes[1].childNodes[24].value=a.canMove,f.childNodes[1].childNodes[25].value=a.canDelete,f.childNodes[1].childNodes[26].value=a.canUploadFile;var g="[";"undefined"!=typeof a.switcher.exits&&a.switcher.exits.length>1&&(x.each(a.switcher.exits,function(a,b){g+="{",g+='"toNodeId":"'+b.toNodeId+'", ',g+='"friendlyCondition":"'+b.friendlyCondition+'", ',g+='"condition":'+x.workflow.switcherExit.toSwitcherExitConditionText(b)+" ",g+="},"}),","===g.substr(g.length-1,1)&&(g=g.substr(0,g.length-1))),g+="]",f.childNodes[1].childNodes[f.childNodes[1].childNodes.length-2].value=a.switcher.radiation,f.childNodes[1].childNodes[f.childNodes[1].childNodes.length-1].value=g,f.childNodes[2].childNodes[0].innerHTML=a.actorDescription,"undefined"!=typeof f.childNodes[2].childNodes[1]&&(f.childNodes[2].childNodes[1].innerHTML=""),f.childNodes[4].innerHTML=a.actorMethod,f.childNodes[5].innerHTML=a.timelimit,x.workflow.node.sync()},setActorScopeByNodeId:function(a){if(confirm("是否重新设置这个节点的处理者?")){var b="/api/workflow.node.setActorScope.aspx",c='<?xml version="1.0" encoding="utf-8"?>';c+="<request>",c+="<workflowInstanceId><![CDATA["+a.workflowInstanceId+"]]></workflowInstanceId>",c+="<workflowNodeId><![CDATA["+a.workflowNodeId+"]]></workflowNodeId>",c+="<actorScope><![CDATA["+a.actorScope+"]]></actorScope>",c+="</request>",$.post(b,{resultType:"json",xml:c},function(b){var c=x.toJSON(b).message;switch(Number(c.returnCode)){case 0:"undefined"!=typeof a.callback&&a.callback();break;case-1:case 1:alert(c.value)}})}},setActiveNode:function(a){if(confirm("是否强制将当前的节点设置为活动节点?")){var b="/api/workflow.node.setActiveNode.aspx",c='<?xml version="1.0" encoding="utf-8"?>';c+="<request>",c+="<nodeId>"+a.nodeId+"</nodeId>",c+="</request>",$.post(b,{resultType:"json",xml:c},function(b){var c=x.toJSON(b).message;switch(Number(c.returnCode)){case 0:"undefined"!=typeof a.callback&&a.callback();break;case-1:case 1:alert(c.value)}})}},showActorWizard:function(){x.workflow.node.actionMethod="cancel";var a=x.getFriendlyName(location.pathname+"-workflow-node-actorDescription-workflow-node-actorScope-contacts-wizard");window[a]=void 0;var b=null===document.getElementById("workflow-node-contactTypeText")?"all":$("#workflow-node-contactTypeText").val();x.ui.wizards.getContactsWizard({targetViewName:"workflow-node-actorDescription",targetValueName:"workflow-node-actorScope",contactTypeText:b,multiSelection:1,includeProhibited:0,save_callback:function(a){x.workflow.node.actionMethod="save";var b="",c="",d=x.toJSON(a).list;x.each(d,function(a,d){b+=d.text+";",c+=d.value+";"}),";"===c.substr(c.length-1,1)&&(b=b.substr(0,b.length-1),c=c.substr(0,c.length-1)),$("#workflow-node-actorDescription").val(b),$("#workflow-node-actorScope").val(c)},cancel_callback:function(){"cancel"===x.workflow.node.actionMethod}})},getExpectedActors:function(){var a="",b=x.workflow.settings,c=$(b.workflowNodeSelector);a='<?xml version="1.0" encoding="utf-8" ?>',a+="<request>",a+="<corporationId><![CDATA["+$("#workflow-template-corporationId").val()+"]]></corporationId>",a+="<projectId><![CDATA["+$("#workflow-template-projectId").val()+"]]></projectId>",a+="<startActorId><![CDATA["+$("#workflow-template-startActorId").val()+"]]></startActorId>",a+="<startRoleId><![CDATA["+$("#workflow-template-startRoleId").val()+"]]></startRoleId>";for(var d=0;d<c.length;d++)arguments.length>0&&arguments[0]!=c[d].childNodes[1].childNodes[1].value||(a+="<node>",a+="<id><![CDATA["+c[d].childNodes[1].childNodes[1].value+"]]></id>",a+="<actorScope><![CDATA["+c[d].childNodes[1].childNodes[4].value+"]]></actorScope>",a+="</node>");a+="</request>",x.net.xhr("/api/workflow.client.getExpectedActors.aspx",a,{waitingType:"mini",waitingMessage:i18n.strings.msg_net_waiting_query_tip_text,callback:function(a){var b=x.toJSON(a).data;x.each(b,function(a,b){""===b.expectedActors?$("#"+b.id+"_expectedActors").attr("class","x-workflow-node-expected-actors-notfound").html("(<label>未找到预计执行人.</label>)"):$("#"+b.id+"_expectedActors").attr("class","x-workflow-node-expected-actors").html("(<label><strong>预计执行人:</strong>"+b.expectedActors+"</label>)")})}})}},x.dom.util.checkbox={getValue:function(a){for(var b="",c=document.getElementsByName(a),d=0;d<c.length;d++)c[d].checked&&(b+=(""==b?"":",")+c[d].value);return b.trim(",")},setValue:function(a,b){for(var c=document.getElementsByName(a),d=0;d<c.length;d++)c[d].value==b&&(c[d].checked=!0,x.dom.checkbox.setCheckboxViewValue(c[d].id,!0))},selectAll:function(a,b){var c=document.getElementsByName(a);b="undefined"==typeof b?!0:b;for(var d=0;d<c.length;d++)c[d].checked=b},selectInverse:function(a){for(var b=document.getElementsByName(a),c=0;c<b.length;c++)b[c].checked=!b[c].checked}},x.workflow.historyNode={showDiscussDialog:function(){var a="";a+='<table style="width: 100%;" class="table-style border-4" >',a+="<tr>",a+='<td class="table-header border-4">协商</td>',a+="</tr>",a+="<tr>",a+='<td class="table-body">',a+='<table class="table-style" style="width:100%" >',a+='<tr class="table-row-normal" >',a+='<td class="table-body-text" >标题</td>',a+='<td class="table-body-input" colspan="3"></td>',a+="<span>"+title+"</span>",a+='<input id="discussHistotyNodeId" name="discussHistotyNodeId" type="hidden" value="'+historyNodeId+'" />',a+="</td>",a+="</tr>",a+='<tr class="table-row-normal" >',a+='<td class="table-body-text" style="width: 120px;" >发起人</td>',a+='<td class="table-body-input" style="width: 200px;" ></td>',a+='<td class="table-body-text" style="width: 120px;" >发起时间</td>',a+='<td class="table-body-input" ></td>',a+="</tr>",a+='<tr class="table-row-normal" >',a+='<td class="table-body-text" >发送人</td>',a+='<td class="table-body-input" >dd</td>',a+='<td class="table-body-text" >接收人</td>',a+='<td class="table-body-input" ></td>',a+="</tr>",a+='<tr class="table-row-normal" >',a+='<td class="table-body-text" >意见</td>',a+='<td class="table-body-input" colspan="3" ><textarea></textarea></td>',a+="</tr>",a+='<tr class="table-row-normal" >',a+='<td class="table-body-text" >通知方式</td>',a+='<td class="table-body-input" colspan="3" >',a+='<div class="checkbox-wrapper" >',a+='<input type="checkbox" /><label>待办</label> ',a+='<input type="checkbox" /><label>邮件</label>',a+='<input type="checkbox" /><label>短信</label>',a+="</div>",a+="</td>",a+="</tr>",a+='<tr class="table-row-normal" >',a+='<td class="table-body-text" >&nbsp;</td>',a+='<td class="table-body-input" colspan="3" >',a+='<div class="button-2font-wrapper" ><a class="button-text" href="#">发送</a></div>',a+="</td>",a+="</tr>",a+="</table>",a+="</td>",a+="</tr>",a+="<tr>",a+='<td class="table-footer" ><img style="height: 18px;" src="/resources/images/transparent.gif"></td>',a+="</tr>",a+="</table>";var b=x.workflow.node.maskWrapper.open();$(b).html(a)},discuss:function(a){var b="/api/workflow.historyNode.discuss.save.aspx",c='<?xml version="1.0" encoding="utf-8" ?>';c+="<ajaxStorage>",c+="<workflowHistoryNodeId><![CDATA["+a.workflowHistoryNodeId+"]]></workflowHistoryNodeId>",c+="<fromActorId><![CDATA["+a.fromActorId+"]]></fromActorId>",c+="<toActorId><![CDATA["+a.toActorId+"]]></toActorId>",c+="<idea><![CDATA["+a.idea+"]]></idea>",c+="</ajaxStorage>",x.net.xhr(b,c,a)}},x.workflow.switcherExit={maskWrapper:x.ui.mask.newMaskWrapper("x-workflow-switcherExit-maskWrapper",{draggableHeight:504,draggableWidth:738}),currentIndex:0,edit:function(a){x.workflow.switcherExit.currentIndex=a;var b=x.workflow.switcherExit.getSwitcherExitObject(a),c="";c+='<div id="workflow-node-switcher-exit-name-'+a+'" class="winodw-wizard-wrapper" style="width:720px; height:auto;" >',c+='<div class="winodw-wizard-toolbar" >',c+='<div class="winodw-wizard-toolbar-close">',c+='<a href="javascript:x.workflow.switcherExit.maskWrapper.close();" title="关闭" ><i class="fa fa-close"></i></a>',c+="</div>",c+='<div class="float-left">',c+='<div class="winodw-wizard-toolbar-item" style="width:200px;" ><span>编辑分支条件</span></div>',c+='<div class="clear"></div>',c+="</div>",c+='<div class="clear"></div>',c+="</div>",c+='<input id="workflow-node-switcher-exit-index" type="hidden" value="'+a+'" />',c+='<table class="table-style" style="width:100%;" >',c+='<tr class="table-row-normal-transparent" >',c+='<td ><input id="workflow-node-switcher-exit-condition-join" type="text" x-dom-feature="combobox" topOffset="-1" x-dom-xhr-url="/api/application.setting.getCombobox.aspx" x-dom-xhr-params="{applicationSettingGroupName:\'应用管理_协同平台_工作流管理_分支出口条件管理_链接方式\'}" x-dom-combobox-icon-hidden="1" class="form-control" style="width:53px" /></td>',c+='<td ><input id="workflow-node-switcher-exit-condition-leftBracket" type="text" x-dom-feature="combobox" topOffset="-1" x-dom-xhr-url="/api/application.setting.getCombobox.aspx" x-dom-xhr-params="{applicationSettingGroupName:\'应用管理_协同平台_工作流管理_分支出口条件管理_左侧括号\'}" x-dom-combobox-icon-hidden="1" class="form-control" style="width:50px" /></td>',c+="<td >",c+='<div class="form-inline">',c+='<div class="input-group">',c+='<input id="workflow-node-switcher-exit-condition-expression1-view" type="text" class="form-control" readonly="readonly" style="width:120px" /> ',c+='<input id="workflow-node-switcher-exit-condition-expression1" type="hidden"/> ',c+='<a href="javascript:x.workflow.switcherExit.expression.edit(\'workflow-node-switcher-exit-condition-expression1\',\'left\');" title="编辑" class="input-group-addon"><span class="glyphicon glyphicon-modal-window"></span></a>',c+="</div>",c+="</div>",c+="</td>",c+='<td ><input id="workflow-node-switcher-exit-condition-compare" type="text" x-dom-feature="combobox" topOffset="-1" x-dom-xhr-url="/api/application.setting.getCombobox.aspx" x-dom-xhr-params="{applicationSettingGroupName:\'应用管理_协同平台_工作流管理_分支出口条件管理_判断方式\'}"  x-dom-combobox-icon-hidden="1" class="form-control" style="width:75px" /></td>',c+="<td >",c+='<input id="workflow-node-switcher-exit-condition-expression2" type="hidden"/> ',c+='<input id="workflow-node-switcher-exit-condition-handmade" type="hidden" /> ',c+='<input id="workflow-node-switcher-exit-condition-expression2-view" type="text" class="form-control" style="width:120px" /> ',c+="</td>",c+='<td ><input id="workflow-node-switcher-exit-condition-rightBracket" type="text" x-dom-feature="combobox" topOffset="-1" x-dom-xhr-url="/api/application.setting.getCombobox.aspx" x-dom-combobox-icon-hidden="1" x-dom-xhr-params="{applicationSettingGroupName:\'应用管理_协同平台_工作流管理_分支出口条件管理_右侧括号\'}" x-dom-combobox-icon-hidden="1" class="form-control" style="width:50px" /></td>',c+="<td >",c+='<button onclick="javascript:x.workflow.switcherExit.condition.setEditConditionObject();" class="btn btn-default" >确定</button>',c+="</td>",c+="</tr>",c+="</table>",c+='<div style="padding:0; height:auto; border-top:1px solid #ccc;" >',c+='<table id="workflow-node-switcher-exit-wizard-condition$table" class="table-style" style="width:100%;" >',c+='<tr class="table-row-title" >',c+='<td style="width:80px;">链接方式</td>',c+="<td >表达式</td>",c+='<td style="width:30px;" title="编辑" ><i class="fa fa-edit" ></i></td>',c+='<td style="width:30px;" title="删除" ><i class="fa fa-trash" ></i></td>',c+="</tr>",c+='<tr class="table-row-normal-transparent workflow-switcher-exit-condition-new" >',c+='<td colspan="4" style="text-align:right;" ><a href="javascript:x.workflow.switcherExit.condition.reset();" >新增分支条件</a></td>',c+="</tr>",c+="</table>",c+="</div>",c+='<div style="border-top:1px solid #ccc;padding:10px 20px 10px 0;" >',c+='<div class="float-right button-2font-wrapper" ><a id="btnCancel" href="javascript:x.workflow.switcherExit.maskWrapper.close();" class="btn btn-default" >取消</a></div> ',c+='<div class="float-right button-2font-wrapper" style="margin-right:10px;" ><a id="btnOkey" href="javascript:x.workflow.switcherExit.save();" class="btn btn-default" >保存</a></div> ',c+='<div class="clear"></div>',c+="</div>",c+="</div>",x.ui.mask.getWindow({content:c},x.workflow.switcherExit.maskWrapper),x.workflow.switcherExit.setConditionTable(b),$("#btnCancel").bind("click",function(){x.workflow.node.maskWrapper.close()}),x.page.goTop(),x.dom.features.bind(),x.workflow.switcherExit.condition.reset()},save:function(){var a=$(x.workflow.settings.workflowSwitcherExitConditionSelector),b=($(x.workflow.settings.workflowSwitcherExitConditionSelector),"");b="[";for(var c=0;c<a.length;c++)b+="{",b+='"join":"'+a[c].childNodes[1].childNodes[1].value+'", ',b+='"joinText":"'+a[c].childNodes[1].childNodes[2].value+'", ',b+='"leftBracket":"'+a[c].childNodes[1].childNodes[3].value+'", ',b+='"expression1":"'+a[c].childNodes[1].childNodes[4].value+'", ',b+='"expression1Text":"'+a[c].childNodes[1].childNodes[5].value+'", ',b+='"compare":"'+a[c].childNodes[1].childNodes[6].value+'", ',b+='"compareText":"'+a[c].childNodes[1].childNodes[7].value+'", ',b+='"expression2":"'+a[c].childNodes[1].childNodes[8].value+'", ',b+='"expression2Text":"'+a[c].childNodes[1].childNodes[9].value+'", ',b+='"handmade":"'+a[c].childNodes[1].childNodes[10].value+'", ',b+='"rightBracket":"'+a[c].childNodes[1].childNodes[11].value+'", ',b+='"friendlyText":"'+a[c].childNodes[1].childNodes[0].innerHTML.replace(/&nbsp;/g," ")+'" ',b+="},";","===b.substr(b.length-1,1)&&(b=b.substr(0,b.length-1)),b+="]",document.getElementById("workflow-node-switcher-exit"+x.workflow.switcherExit.currentIndex).checked=b.length>2?!0:!1,document.getElementById("workflow-node-switcher-exit"+x.workflow.switcherExit.currentIndex+"-condition").value=b,b="";for(var c=0;c<a.length;c++)b+=a[c].childNodes[1].childNodes[2].value+" "+a[c].childNodes[1].childNodes[0].innerHTML+" ",b=b.replace(/&nbsp;/g," ");document.getElementById("workflow-node-switcher-exit"+x.workflow.switcherExit.currentIndex+"-friendlyCondition").value=b,document.getElementById("workflow-node-switcher-exit"+x.workflow.switcherExit.currentIndex+"-friendlyConditionText").innerHTML=b,x.workflow.switcherExit.maskWrapper.close()},setConditionTable:function(a){for(var b=a.condition,c="",d=0;d<b.length;d++){var e=b[d],f="workflow-node-switcher-exit-condition-"+(d+1);c+='<tr class="table-row-normal workflow-switcher-exit-condition" >',c+="<td>"+e.joinText+"</td>",c+="<td>",c+="<span>"+e.friendlyText+"</span>",c+='<input id="'+f+'-join" type="hidden" value="'+e.join+'" />',c+='<input id="'+f+'-joinText" type="hidden" value="'+e.joinText+'" />',c+='<input id="'+f+'-leftBracket" type="hidden" value="'+e.leftBracket+'" />',c+='<input id="'+f+'-expression1" type="hidden" value="'+e.expression1+'" />',c+='<input id="'+f+'-expression1Text" type="hidden" value="'+e.expression1Text+'" />',c+='<input id="'+f+'-compare" type="hidden" value="'+e.compare+'" />',c+='<input id="'+f+'-compareText" type="hidden" value="'+e.compareText+'" />',c+='<input id="'+f+'-expression2" type="hidden" value="'+e.expression2+'" />',c+='<input id="'+f+'-expression2Text" type="hidden" value="'+e.expression2Text+'" />',c+='<input id="'+f+'-handmade" type="hidden" value="'+e.handmade+'" />',c+='<input id="'+f+'-rightBracket" type="hidden" value="'+e.rightBracket+'" />',c+="</td>",c+='<td><a href="javascript:x.workflow.switcherExit.condition.edit('+(d+1)+')" title="编辑" ><i class="fa fa-edit" ></i></a></td>',c+='<td><a href="javascript:x.workflow.switcherExit.condition.remove('+(d+1)+')" title="删除" ><i class="fa fa-trash" ></i></a></td>',c+="</tr>"}$(x.workflow.settings.workflowSwitcherExitConditionNewSelector).before(c)},getSwitcherExitObject:function(a){var b="{";return""===document.getElementById("workflow-node-switcher-exit"+a+"-condition").value&&(document.getElementById("workflow-node-switcher-exit"+a+"-condition").value="[]"),b+='"toNodeId":"'+document.getElementById("workflow-node-switcher-exit"+a+"-toNodeId").value+'",',b+='"condition":'+document.getElementById("workflow-node-switcher-exit"+a+"-condition").value+",",b+='"friendlyCondition":"'+document.getElementById("workflow-node-switcher-exit"+a+"-friendlyCondition").value+'"',b+="}",x.toJSON(b)},toSwitcherExitConditionText:function(a){for(var b="[",c=0;c<a.condition.length;c++)b+="{",b+='"join":"'+a.condition[c].join+'", ',b+='"joinText":"'+a.condition[c].joinText+'", ',b+='"leftBracket":"'+a.condition[c].leftBracket+'", ',b+='"expression1":"'+a.condition[c].expression1+'", ',b+='"expression1Text":"'+a.condition[c].expression1Text+'", ',b+='"compare":"'+x.encoding.html.encode(a.condition[c].compare)+'", ',b+='"compareText":"'+a.condition[c].compareText+'", ',b+='"expression2":"'+a.condition[c].expression2+'", ',b+='"expression2Text":"'+a.condition[c].expression2Text+'", ',b+='"handmade":"'+a.condition[c].handmade+'", ',b+='"rightBracket":"'+a.condition[c].rightBracket+'", ',b+='"friendlyText":"'+a.condition[c].friendlyText+'" ',b+="},";return","===b.substr(b.length-1,1)&&(b=b.substr(0,b.length-1)),b+="]"},condition:{currentIndex:0,reset:function(){x.workflow.switcherExit.condition.currentIndex=0,$("#workflow-node-switcher-exit-condition-join").val("AND"),$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-join-view").val("并且"),$("#workflow-node-switcher-exit-condition-leftBracket").val("("),$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-leftBracket-view").val("("),$("#workflow-node-switcher-exit-condition-expression1").val(""),$("#workflow-node-switcher-exit-condition-expression1-view").val(""),$("#workflow-node-switcher-exit-condition-compare").val("="),$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-compare-view").val("等于"),$("#workflow-node-switcher-exit-condition-expression2").val(""),$("#workflow-node-switcher-exit-condition-expression2-view").val(""),$("#workflow-node-switcher-exit-condition-handmade").val(0),$("#workflow-node-switcher-exit-condition-rightBracket").val(")"),$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-rightBracket-view").val(")")},sync:function(){for(var a=$(x.workflow.settings.workflowSwitcherExitConditionSelector),b=0;b<a.length;b++){var c=a[b],d=b+1,e="workflow-node-switcher-exit-condition-"+d;c.childNodes[1].childNodes[1].id=e+"-join",c.childNodes[1].childNodes[2].id=e+"-joinText",c.childNodes[1].childNodes[3].id=e+"-leftBracket",c.childNodes[1].childNodes[4].id=e+"-expression1",c.childNodes[1].childNodes[5].id=e+"-expression1Text",c.childNodes[1].childNodes[6].id=e+"-compare",c.childNodes[1].childNodes[7].id=e+"-compareText",c.childNodes[1].childNodes[8].id=e+"-expression2",c.childNodes[1].childNodes[9].id=e+"-expression2Text",c.childNodes[1].childNodes[10].id=e+"-handmade",c.childNodes[1].childNodes[11].id=e+"-rightBracket",c.childNodes[2].innerHTML='<a href="javascript:x.workflow.switcherExit.condition.edit('+d+')" title="编辑" ><i class="fa fa-edit" ></i></a>',c.childNodes[3].innerHTML='<a href="javascript:x.workflow.switcherExit.condition.remove('+d+')" title="删除" ><i class="fa fa-trash" ></i></a>'}},edit:function(a){x.workflow.switcherExit.condition.currentIndex=a;var b="workflow-node-switcher-exit-condition",c="workflow-node-switcher-exit-condition-"+a;document.getElementById(b+"-join").value=document.getElementById(c+"-join").value,document.getElementById(b+"-join-view").value=document.getElementById(c+"-joinText").value,document.getElementById(b+"-leftBracket").value=document.getElementById(c+"-leftBracket").value,document.getElementById(b+"-leftBracket-view").value=document.getElementById(c+"-leftBracket").value,document.getElementById(b+"-expression1").value=document.getElementById(c+"-expression1").value,document.getElementById(b+"-expression1-view").value=document.getElementById(c+"-expression1Text").value,document.getElementById(b+"-compare").value=document.getElementById(c+"-compare").value,document.getElementById(b+"-compare-view").value=document.getElementById(c+"-compareText").value,document.getElementById(b+"-expression2").value=document.getElementById(c+"-expression2").value,document.getElementById(b+"-expression2-view").value=document.getElementById(c+"-expression2Text").value,document.getElementById(b+"-handmade").value=document.getElementById(c+"-handmade").value,document.getElementById(b+"-rightBracket").value=document.getElementById(c+"-rightBracket").value,document.getElementById(b+"-rightBracket-view").value=document.getElementById(c+"-rightBracket").value,x.form.query(b+"expression1-view").css({"text-decoration":"underline","font-weight":"bold"}),x.form.query(b+"expression2-view").css("0"==document.getElementById(c+"-handmade").value?{"text-decoration":"underline","font-weight":"bold"}:{"text-decoration":"none","font-weight":"normal"})},remove:function(a){var b=$(x.workflow.settings.workflowSwitcherExitConditionSelector)[a-1];b&&$(b).remove(),x.workflow.switcherExit.condition.sync()},setEditConditionObject:function(){var a=$(x.workflow.settings.workflowSwitcherExitConditionSelector),b=x.workflow.switcherExit.condition.getEditConditionObject(),c="",d=x.workflow.switcherExit.condition.currentIndex;if(0===d){d=a.length+1;var e="workflow-node-switcher-exit-condition-"+d;c+='<tr class="table-row-normal workflow-switcher-exit-condition" >',c+="<td>"+(1===d?"":b.joinText)+"</td>",c+="<td>",c+="<span>"+b.friendlyText+"</span>",c+='<input id="'+e+'-join" type="hidden" value="'+(1===d?"":b.join)+'" />',c+='<input id="'+e+'-joinText" type="hidden" value="'+(1===d?"":b.joinText)+'" />',c+='<input id="'+e+'-leftBracket" type="hidden" value="'+b.leftBracket+'" />',c+='<input id="'+e+'-expression1" type="hidden" value="'+b.expression1+'" />',c+='<input id="'+e+'-expression1Text" type="hidden" value="'+b.expression1Text+'" />',c+='<input id="'+e+'-compare" type="hidden" value="'+b.compare+'" />',c+='<input id="'+e+'-compareText" type="hidden" value="'+b.compareText+'" />',c+='<input id="'+e+'-expression2" type="hidden" value="'+b.expression2+'" />',c+='<input id="'+e+'-expression2Text" type="hidden" value="'+b.expression2Text+'" />',c+='<input id="'+e+'-handmade" type="hidden" value="'+b.handmade+'" />',c+='<input id="'+e+'-rightBracket" type="hidden" value="'+b.rightBracket+'" />',c+="</td>",c+='<td><a href="javascript:x.workflow.switcherExit.condition.edit('+d+')" title="编辑" ><i class="fa fa-edit" ></i></a></td>',c+='<td><a href="javascript:x.workflow.switcherExit.condition.remove('+d+')" title="删除" ><i class="fa fa-trash" ></i></a></td>',c+="</tr>",$(x.workflow.settings.workflowSwitcherExitConditionNewSelector).before(c)}else{var f=a[d-1];f.childNodes[0].innerHTML=1===d?"":b.joinText,f.childNodes[1].childNodes[0].innerHTML=b.friendlyText,f.childNodes[1].childNodes[1].value=1===d?"":b.join,f.childNodes[1].childNodes[2].value=1===d?"":b.joinText,f.childNodes[1].childNodes[3].value=b.leftBracket,f.childNodes[1].childNodes[4].value=b.expression1,f.childNodes[1].childNodes[5].value=b.expression1Text,f.childNodes[1].childNodes[6].value=b.compare,f.childNodes[1].childNodes[7].value=b.compareText,f.childNodes[1].childNodes[8].value=b.expression2,f.childNodes[1].childNodes[9].value=b.expression2Text,f.childNodes[1].childNodes[10].value=b.handmade,f.childNodes[1].childNodes[11].value=b.rightBracket}x.debug.log("x.workflow.switcherExit.save();"),x.debug.log(b),x.workflow.switcherExit.condition.reset()},getEditConditionObject:function(){var a=($("#workflow-node-switcher-exit-condition-join").val(),$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-leftBracket-view").val()),b=$("#workflow-node-switcher-exit-condition-expression1-view").val(),c=$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-compare-view").val(),d=$("#workflow-node-switcher-exit-condition-expression2-view").val(),e=$("#workflow-node-switcher-exit-condition-handmade"),f=$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-rightBracket-view").val(),g=a+""+b+" "+c+" "+d+f;"1"===e&&$("#workflow-node-switcher-exit-condition-expression2").val($("#workflow-node-switcher-exit-condition-expression2-view").val());var h="";return h+="{",h+='"join":"'+$("#workflow-node-switcher-exit-condition-join").val()+'", ',h+='"joinText":"'+$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-join-view").val()+'", ',h+='"leftBracket":"'+$("#workflow-node-switcher-exit-condition-leftBracket").val()+'", ',h+='"expression1":"'+$("#workflow-node-switcher-exit-condition-expression1").val()+'", ',h+='"expression1Text":"'+$("#workflow-node-switcher-exit-condition-expression1-view").val()+'", ',h+='"compare":"'+$("#workflow-node-switcher-exit-condition-compare").val()+'", ',h+='"compareText":"'+$("#"+x.ui.classNamePrefix+"-workflow-node-switcher-exit-condition-compare-view").val()+'", ',h+='"expression2":"'+$("#workflow-node-switcher-exit-condition-expression2").val()+'", ',h+='"expression2Text":"'+$("#workflow-node-switcher-exit-condition-expression2-view").val()+'", ',h+='"handmade":"'+($("#workflow-node-switcher-exit-condition-handmade")[0].checked?1:0)+'", ',h+='"rightBracket":"'+$("#workflow-node-switcher-exit-condition-rightBracket").val()+'", ',h+='"friendlyText":"'+g+'" ',h+="}",x.toJSON(h)}},expression:{maskWrapper:x.ui.mask.newMaskWrapper("x-workflow-switcherExit-expression-maskWrapper",{draggableHeight:504,draggableWidth:738}),getTreeView:function(a,b){var c="10000000-0000-0000-0000-000000000000",d="选择表达式",e="00000000-0000-0000-0000-000000000001",f="javascript:x.workflow.switcherExit.expression.setTreeViewNode('{treeNodeId}','{treeNodeName}')",g="04-E01,04-E02"+("undefined"===a?"":","+a),h='<?xml version="1.0" encoding="utf-8" ?>';h+="<request>",h+="<action><![CDATA[getDynamicTreeView]]></action>",h+="<treeViewId><![CDATA["+c+"]]></treeViewId>",h+="<treeViewName><![CDATA["+d+"]]></treeViewName>",h+="<treeViewRootTreeNodeId><![CDATA["+e+"]]></treeViewRootTreeNodeId>",h+="<entitySchemaIds><![CDATA["+g+"]]></entitySchemaIds>",h+="<expressionType><![CDATA["+b+"]]></expressionType>",h+="<tree><![CDATA[{tree}]]></tree>",h+="<parentId><![CDATA[{parentId}]]></parentId>",h+="<url><![CDATA["+f+"]]></url>",h+="</request>";var i=x.ui.pkg.tree.newTreeView({name:"x.workflow.switcherExit.expression.tree",ajaxMode:!0});i.add({id:"0",parentId:"-1",name:d,url:f.replace("{treeNodeId}",e),title:d,target:"",icon:"/resources/images/tree/tree_icon.gif"}),i.load("/api/workflow.expression.getDynamicTreeView.aspx",!1,h);var j=x.workflow.template.getTemplategetInternalMetaData();j.length>0&&(i.add({id:"00000",parentId:"0",name:"表单内置信息",url:"javascript:void(0);"}),x.each(j,function(a,b){i.add({id:"00000-"+a,parentId:"00000",name:b.fieldName,url:"javascript:x.workflow.switcherExit.expression.setTreeViewNode('meta:"+b.fieldType+"#"+b.dataColumnName+"','"+b.fieldName+"')"})})),x.workflow.switcherExit.expression.tree=i,$("#workflow-switcherExit-expression-wizardTreeViewContainer")[0].innerHTML=i},setTreeViewNode:function(a,b){$("#workflow-switcherExit-expression-wizardExpressionText").val(b),$("#workflow-switcherExit-expression-wizardExpressionValue").val(a)},edit:function(a,b){var c="";c+='<div id="'+a+'-edit" class="winodw-wizard-wrapper" style="width:300px; height:auto;" >',c+='<div class="winodw-wizard-toolbar" >',c+='<div class="winodw-wizard-toolbar-close">',c+='<a href="javascript:x.workflow.switcherExit.expression.maskWrapper.close();" title="关闭" ><i class="fa fa-close"></i></a>',c+="</div>",c+='<div class="float-left">',c+='<div class="winodw-wizard-toolbar-item" style="width:200px;" ><span>设置表达式</span></div>',c+='<div class="clear"></div>',c+="</div>",c+='<div class="clear"></div>',c+="</div>",c+='<div id="workflow-switcherExit-expression-wizardTreeViewContainer" class="winodw-wizard-tree-view" style="height:300px;" ></div>',c+='<div class="winodw-wizard-result-container form-inline text-right" >',c+='<label class="winodw-wizard-result-item-text" >表达式</label> ',c+='<input id="workflow-switcherExit-expression-wizardExpressionText" name="wizardExpressionText" type="text" value="" class="winodw-wizard-result-item-input form-control input-sm" style="width:160px" /> ',c+='<input id="workflow-switcherExit-expression-wizardExpressionValue" name="wizardExpressionValue" type="hidden" value="" />',c+="<a href=\"javascript:x.workflow.switcherExit.expression.save('"+a+'\');" class="btn btn-default btn-sm" >确定</a>',c+="</div>",x.ui.mask.getWindow({content:c},x.workflow.switcherExit.expression.maskWrapper),$("#workflow-switcherExit-expression-wizardExpressionText").val($("#"+a+"-view").val()),$("#workflow-switcherExit-expression-wizardExpressionValue").val($("#"+a).val()),x.net.xhr("/api/kernel.entities.schema.findOneByEntityClassName.aspx?entityClassName="+encodeURIComponent($("#workflow-template-entityClass").val()),{callback:function(a){var c=x.toJSON(a).data;x.workflow.switcherExit.expression.getTreeView(c.id,b)
}})},save:function(a){x.workflow.switcherExit.expression.maskWrapper.close(),$("#"+a+"-view").val($("#workflow-switcherExit-expression-wizardExpressionText").val()),$("#"+a).val($("#workflow-switcherExit-expression-wizardExpressionValue").val()),$("#"+a+"-view").css({"text-decoration":"underline","font-weight":"bold"}),$("#workflow-node-switcher-exit-condition-handmade").val(0)}}};